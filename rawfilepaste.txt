<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POD Design Studio - AI Generator</title>
    <meta name="description" content="Generate unique Print on Demand (POD) designs using AI style transfer and variations.">
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Embedded CSS -->
    <style>
        /* CSS Reset and Root Variables */
        :root {
            --color-primary-start: #6366f1;
            --color-primary-end: #ec4899;
            --color-accent: #06b6d4;
            --color-bg-light: #f8fafc;
            --color-bg-dark: #1e293b;
            --color-card-light: #ffffff;
            --color-card-dark: #334155;
            --color-text-light: #334155;
            --color-text-dark: #f1f5f9;
            --color-border-light: #e2e8f0;
            --color-border-dark: #475569;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition-all: all 300ms ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--color-bg-light);
            color: var(--color-text-light);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Main App Container */
        #app {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 1.5rem 4rem;
        }

        /* Header and Navigation */
        .app-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0 1.5rem;
            border-bottom: 1px solid var(--color-border-light);
            margin-bottom: 2rem;
        }

        .app-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--color-primary-start), var(--color-primary-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .app-nav {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: #64748b;
            border: 1px solid transparent;
            border-bottom: 2px solid transparent;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            cursor: pointer;
            transition: var(--transition-all);
        }

        .nav-tab:hover {
            background-color: #f1f5f9;
        }

        .nav-tab.active {
            color: var(--color-primary-start);
            border-color: var(--color-border-light) var(--color-border-light) var(--color-card-light);
            border-bottom: 2px solid var(--color-primary-start);
            font-weight: 600;
            background-color: var(--color-card-light);
        }

        /* Page Layout */
        .page {
            display: none;
            animation: fadeIn 300ms ease-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        /* Grid for Style Transfer Page */
        #page-style-transfer .content-grid {
            grid-template-columns: repeat(12, 1fr);
        }

        .upload-grid {
            grid-column: span 12;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        @media (min-width: 768px) {
            .upload-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .controls-col {
            grid-column: span 12;
        }

        @media (min-width: 1024px) {
            .upload-grid {
                grid-column: span 7;
            }
            .controls-col {
                grid-column: span 5;
            }
        }

        /* Content Section */
        .content-section {
            background-color: var(--color-card-light);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border-light);
            box-shadow: var(--shadow);
            padding: 1.5rem;
        }

        .content-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Upload Zones */
        .upload-zone {
            border: 2px dashed var(--color-border-light);
            border-radius: var(--radius-lg);
            padding: 2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-all);
            background-color: #fcfdff;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--color-primary-start);
            background-color: #f7f7ff;
        }

        .upload-zone p {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .upload-zone-single {
            padding: 3rem 1.5rem;
        }

        .upload-zone-single .upload-preview {
            max-width: 300px;
            max-height: 300px;
            margin: 0 auto 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border-light);
        }

        .thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .thumbnail-item {
            position: relative;
            aspect-ratio: 1 / 1;
        }

        .thumbnail-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border-light);
            box-shadow: var(--shadow-sm);
        }

        .thumbnail-item .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ef4444;
            color: white;
            border: 2px solid white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            line-height: 1;
            box-shadow: var(--shadow);
            transition: all 150ms ease;
        }

        .thumbnail-item .remove-btn:hover {
            transform: scale(1.1);
            background-color: #dc2626;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border-light);
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            resize: vertical;
        }

        .textarea:focus {
            outline: 0;
            border-color: var(--color-primary-start);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .char-counter {
            text-align: right;
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        .number-control {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .number-control-slider {
            flex-grow: 1;
        }

        .number-input-wrapper {
            display: flex;
            align-items: center;
        }

        .number-btn {
            width: 38px;
            height: 38px;
            border: 1px solid var(--color-border-light);
            background-color: #f1f5f9;
            color: var(--color-text-light);
            font-size: 1.25rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 150ms ease;
        }
        .number-btn:hover {
            background-color: #e2e8f0;
        }
        .number-btn:first-child {
            border-radius: var(--radius-md) 0 0 var(--radius-md);
        }
        .number-btn:last-child {
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
        }
        
        .number-input {
            width: 60px;
            height: 38px;
            text-align: center;
            border: 1px solid var(--color-border-light);
            border-left: 0;
            border-right: 0;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 0 0.25rem;
            -moz-appearance: textfield;
        }
        .number-input::-webkit-outer-spin-button,
        .number-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .number-display {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-primary-start);
            min-width: 40px;
            text-align: center;
        }

        /* API Panel */
        .api-panel {
            background-color: #f1f5f9;
            border-radius: var(--radius-lg);
            padding: 1rem 1.5rem;
            margin-top: 1.5rem;
        }

        .api-toggle-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .api-toggle-wrapper label {
            font-weight: 500;
        }

        /* Fancy Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--color-primary-start);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .api-key-input-wrapper {
            display: none;
            margin-top: 1rem;
        }
        
        .api-key-input-wrapper.active {
            display: block;
        }

        .api-key-input {
            position: relative;
        }
        
        .api-key-input input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 1rem;
            border: 1px solid var(--color-border-light);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
        }

        .api-key-input .info-icon {
            position: absolute;
            right: 2.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            cursor: help;
        }
        
        .api-key-input .validation-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }
        .api-key-input .validation-icon.valid {
            color: #22c55e;
        }
        .api-key-input .validation-icon.invalid {
            color: #ef4444;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: var(--radius-md);
            padding: 0.5rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
        }
        
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #334155 transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            width: 100%;
            padding: 0.85rem 1.5rem;
            border: 0;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: var(--transition-all);
        }

        .btn-primary {
            background: linear-gradient(to right, var(--color-primary-start), var(--color-primary-end));
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            opacity: 0.9;
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            background: #cbd5e1;
            color: #94a3b8;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-secondary {
            background-color: var(--color-card-light);
            color: var(--color-text-light);
            border: 1px solid var(--color-border-light);
        }
        
        .btn-secondary:hover {
            background-color: #f1f5f9;
        }

        .btn-danger {
            background-color: #f87171;
            color: white;
        }
        .btn-danger:hover {
            background-color: #ef4444;
        }
        
        .btn-icon {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.8);
            color: white;
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .btn-icon svg {
            width: 20px;
            height: 20px;
        }

        /* Results Gallery */
        .results-section {
            margin-top: 2.5rem;
            padding-top: 2rem;
            border-top: 1px solid var(--color-border-light);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .results-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .results-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .placeholder-gallery {
            border: 2px dashed var(--color-border-light);
            border-radius: var(--radius-lg);
            padding: 4rem 2rem;
            text-align: center;
            color: #94a3b8;
        }
        .placeholder-gallery svg {
            width: 60px;
            height: 60px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .result-card {
            background: var(--color-card-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
            aspect-ratio: 1 / 1;
            border: 1px solid var(--color-border-light);
        }

        .result-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 300ms ease;
        }

        .result-card .overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.1) 40%, rgba(0,0,0,0.7) 100%);
            opacity: 0;
            transition: var(--transition-all);
        }
        
        .result-card:hover .overlay {
            opacity: 1;
        }
        
        .result-card:hover img {
            transform: scale(1.05);
        }

        .result-card .actions {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            transform: translateY(20px);
            opacity: 0;
            transition: all 300ms ease;
        }
        
        .result-card:hover .actions {
            transform: translateY(0);
            opacity: 1;
        }

        .result-card .timestamp {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-md);
            backdrop-filter: blur(4px);
            opacity: 0;
            transition: var(--transition-all);
        }
        
        .result-card:hover .timestamp {
            opacity: 1;
        }

        /* Modals */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(26, 32, 44, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 100;
            animation: fadeIn 250ms ease;
        }

        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--color-card-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            position: relative;
            animation: slideIn 300ms ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            border: 0;
            background: #f1f5f9;
            color: #64748b;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 150ms ease;
        }
        .modal-close-btn:hover {
            background: #e2e8f0;
            transform: rotate(90deg);
        }

        /* Image View Modal */
        #image-view-modal .modal-content {
            background: transparent;
            padding: 0;
            box-shadow: none;
            max-width: 90vw;
            max-height: 90vh;
        }
        
        #image-view-modal img {
            width: 100%;
            height: 100%;
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: var(--radius-lg);
        }
        
        #image-view-modal .modal-close-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            top: -10px;
            right: -10px;
        }
        
        #image-view-modal .modal-actions {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Edit Dialog Modal */
        #edit-dialog-modal h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        
        #edit-dialog-modal .original-image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border-light);
            margin-bottom: 1rem;
            float: right;
            margin-left: 1rem;
        }
        
        #edit-dialog-modal .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }
        
        #edit-dialog-modal .modal-actions .btn {
            width: auto;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 200;
            transition: var(--transition-all);
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #e2e8f0;
            border-top-color: var(--color-primary-start);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-overlay p {
            font-weight: 500;
            margin-top: 1.5rem;
            color: var(--color-text-light);
            font-size: 1.1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            width: 350px;
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            animation: slideInRight 300ms ease, fadeOut 300ms ease 4.7s forwards;
        }
        
        .toast.error {
            background-color: #ef4444;
        }
        
        .toast.success {
            background-color: #22c55e;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Responsive Design */
        @media (max-width: 767px) {
            .app-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            #app {
                padding: 0.5rem 0.75rem 3rem;
            }
            
            .content-section {
                padding: 1rem;
            }
            
            .results-gallery {
                grid-template-columns: 1fr;
            }
        }

        /* Utility */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <!-- Main App Wrapper -->
    <div id="app">

        <!-- App Header -->
        <header class="app-header">
            <h1>POD Design Studio</h1>
            <nav class="app-nav">
                <button class="nav-tab active" data-page="page-style-transfer" aria-label="Switch to Style Transfer page">Style Transfer</button>
                <button class="nav-tab" data-page="page-variations" aria-label="Switch to Variations Generator page">Variations Generator</button>
            </nav>
        </header>

        <!-- App Main Content -->
        <main>

            <!-- ====================================================== -->
            <!-- PAGE 1: STYLE TRANSFER GENERATOR                       -->
            <!-- ====================================================== -->
            <section id="page-style-transfer" class="page active">
                <div class="content-grid">

                    <!-- Uploads Column -->
                    <div class="upload-grid">
                        <!-- Art Style Upload -->
                        <div class="content-section">
                            <h2>Art Style References</h2>
                            <div class="upload-zone" id="style-upload-zone" aria-label="Drag and drop art style reference images">
                                <input type="file" id="style-file-input" multiple accept="image/png, image/jpeg, image/webp" class="hidden">
                                <p>Drag & drop or click to upload<br>(Max 4 images, 5MB each)</p>
                            </div>
                            <div class="thumbnail-grid" id="style-thumbnail-grid">
                                <!-- Thumbnails injected by JS -->
                            </div>
                        </div>

                        <!-- Niche Concept Upload -->
                        <div class="content-section">
                            <h2>Niche Design Concepts</h2>
                            <div class="upload-zone" id="concept-upload-zone" aria-label="Drag and drop niche design concept images">
                                <input type="file" id="concept-file-input" multiple accept="image/png, image/jpeg, image/webp" class="hidden">
                                <p>Drag & drop or click to upload<br>(Max 4 images, 5MB each)</p>
                            </div>
                            <div class="thumbnail-grid" id="concept-thumbnail-grid">
                                <!-- Thumbnails injected by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Controls Column -->
                    <div class="controls-col">
                        <div class="content-section">
                            <!-- Prompt Input -->
                            <div class="form-group">
                                <label for="style-prompt">Add Your Ideas (Optional)</label>
                                <textarea id="style-prompt" class="textarea" rows="4" maxlength="500" placeholder="e.g., 'Create a vintage sunset design with the dog from concept image in watercolor style'"></textarea>
                                <div class="char-counter" id="style-prompt-counter">500</div>
                            </div>

                            <!-- Number to Generate -->
                            <div class="form-group">
                                <label>Number of Designs to Generate</label>
                                <div class="number-control">
                                    <div class="number-input-wrapper">
                                        <button class="number-btn" data-input="style-num-designs" data-action="decrease" aria-label="Decrease number of designs">&minus;</button>
                                        <input type="number" class="number-input" id="style-num-designs" value="10" min="1" max="50">
                                        <button class="number-btn" data-input="style-num-designs" data-action="increase" aria-label="Increase number of designs">&plus;</button>
                                    </div>
                                    <span class="number-display" id="style-num-display">10</span>
                                </div>
                            </div>
                            
                            <!-- API Panel -->
                            <div class="api-panel">
                                <div class="api-toggle-wrapper">
                                    <label for="api-key-toggle-style">Use Internal API</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="api-key-toggle-style" class="api-key-toggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="api-key-input-wrapper" id="api-key-wrapper-style">
                                    <div class="api-key-input">
                                        <input type="password" id="api-key-input-style" class="api-key-input-field" placeholder="Enter Your Gemini API Key">
                                        <span class="info-icon tooltip">
                                            &#9432;
                                            <span class="tooltip-text">Get your free API key from ai.google.dev</span>
                                        </span>
                                        <span class="validation-icon" id="api-key-valid-icon-style" aria-label="API Key valid">&check;</span>
                                        <span class="validation-icon invalid" id="api-key-invalid-icon-style" aria-label="API Key invalid">&times;</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Generate Button -->
                            <button id="generate-style-btn" class="btn btn-primary" style="margin-top: 1.5rem;" disabled>Generate Designs</button>
                        </div>
                    </div>
                </div>
                
                <!-- Results Section -->
                <div class="results-section" id="results-section-style">
                    <div class="results-header">
                         <h2>Your Generated Designs</h2>
                         <button id="clear-style-btn" class="btn btn-secondary btn-danger" style="width: auto;">Clear All</button>
                    </div>
                    <div class="results-gallery" id="results-gallery-style">
                        <div class="placeholder-gallery" id="placeholder-style">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                            <p>Your generated designs will appear here.<br>Upload your images and click "Generate" to start.</p>
                        </div>
                        <!-- Results injected by JS -->
                    </div>
                </div>
            </section>

            <!-- ====================================================== -->
            <!-- PAGE 2: VARIATIONS GENERATOR                           -->
            <!-- ====================================================== -->
            <section id="page-variations" class="page">
                <div class="content-grid">

                    <!-- Uploads Column -->
                    <div class="upload-grid">
                        <!-- Single Design Upload -->
                        <div class="content-section">
                            <h2>Upload Your Design</h2>
                            <div class="upload-zone upload-zone-single" id="variation-upload-zone" aria-label="Drag and drop your base design image">
                                <input type="file" id="variation-file-input" accept="image/png, image/jpeg, image/webp" class="hidden">
                                <img src="" alt="Uploaded design preview" class="upload-preview hidden" id="variation-preview">
                                <p id="variation-placeholder-text">Drag & drop or click to upload<br>(1 image, 5MB max)</p>
                            </div>
                            <div id="variation-upload-actions" class="hidden" style="display: flex; gap: 1rem; margin-top: 1rem;">
                                <button id="variation-replace-btn" class="btn btn-secondary" style="width: 50%;">Replace</button>
                                <button id="variation-remove-btn" class="btn btn-danger" style="width: 50%;">Remove</button>
                            </div>
                        </div>
                    </div>

                    <!-- Controls Column -->
                    <div class="controls-col">
                        <div class="content-section">
                            <!-- Prompt Input -->
                            <div class="form-group">
                                <label for="variation-prompt">Add Your Ideas (Optional)</label>
                                <textarea id="variation-prompt" class="textarea" rows="4" maxlength="500" placeholder="e.g., 'Create versions with different animals - cat, dog, rabbit' or 'Change colors to pastel tones'"></textarea>
                                <div class="char-counter" id="variation-prompt-counter">500</div>
                            </div>
                            
                            <!-- Number to Generate -->
                            <div class="form-group">
                                <label>Number of Variations</label>
                                <div class="number-control">
                                    <div class="number-input-wrapper">
                                        <button class="number-btn" data-input="variation-num-designs" data-action="decrease" aria-label="Decrease number of variations">&minus;</button>
                                        <input type="number" class="number-input" id="variation-num-designs" value="10" min="1" max="50">
                                        <button class="number-btn" data-input="variation-num-designs" data-action="increase" aria-label="Increase number of variations">&plus;</button>
                                    </div>
                                    <input type="range" class="number-control-slider" id="variation-num-slider" value="10" min="1" max="50" style="flex-grow: 1;">
                                    <span class="number-display" id="variation-num-display">10</span>
                                </div>
                            </div>
                            
                            <!-- API Panel -->
                            <div class="api-panel">
                                <div class="api-toggle-wrapper">
                                    <label for="api-key-toggle-variation">Use Internal API</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="api-key-toggle-variation" class="api-key-toggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="api-key-input-wrapper" id="api-key-wrapper-variation">
                                    <div class="api-key-input">
                                        <input type="password" id="api-key-input-variation" class="api-key-input-field" placeholder="Enter Your Gemini API Key">
                                        <span class="info-icon tooltip">
                                            &#9432;
                                            <span class="tooltip-text">Get your free API key from ai.google.dev</span>
                                        </span>
                                        <span class="validation-icon" id="api-key-valid-icon-variation" aria-label="API Key valid">&check;</span>
                                        <span class="validation-icon invalid" id="api-key-invalid-icon-variation" aria-label="API Key invalid">&times;</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Generate Button -->
                            <button id="generate-variation-btn" class="btn btn-primary" style="margin-top: 1.5rem;" disabled>Generate Variations</button>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="results-section" id="results-section-variation">
                     <div class="results-header">
                         <h2>Your Generated Variations</h2>
                         <button id="clear-variation-btn" class="btn btn-secondary btn-danger" style="width: auto;">Clear All</button>
                    </div>
                    <div class="results-gallery" id="results-gallery-variation">
                        <div class="placeholder-gallery" id="placeholder-variation">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                            <p>Your generated variations will appear here.<br>Upload your base design and click "Generate" to start.</p>
                        </div>
                        <!-- Results injected by JS -->
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- ====================================================== -->
    <!-- MODALS & OVERLAYS                                      -->
    <!-- ====================================================== -->

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text">Generating designs...</p>
    </div>

    <!-- Toast Notification Container -->
    <div class="toast-container" id="toast-container">
        <!-- Toasts injected by JS -->
    </div>

    <!-- Full Image View Modal -->
    <div class="modal" id="image-view-modal" aria-modal="true" role="dialog" aria-labelledby="image-view-title">
        <div class="modal-content">
            <h2 id="image-view-title" class="hidden">Full Image View</h2>
            <img src="" alt="Full size generated design" id="full-image-view">
            <div class="modal-actions">
                <button class="btn-icon" id="full-image-download-btn" aria-label="Download full image" title="Download">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                </button>
            </div>
        </div>
        <button class="modal-close-btn" data-modal-id="image-view-modal" aria-label="Close image view">&times;</button>
    </div>

    <!-- Edit Dialog Modal -->
    <div class="modal" id="edit-dialog-modal" aria-modal="true" role="dialog" aria-labelledby="edit-dialog-title">
        <div class="modal-content">
            <h3 id="edit-dialog-title">Edit Design</h3>
            <button class="modal-close-btn" data-modal-id="edit-dialog-modal" aria-label="Close edit dialog">&times;</button>
            
            <form id="edit-form">
                <img src="" alt="Original design preview" class="original-image-preview" id="edit-image-preview">
                <div class="form-group">
                    <label for="edit-prompt">Describe your edit</label>
                    <textarea id="edit-prompt" class="textarea" rows="3" maxlength="200" placeholder="e.g., 'Change the bear color to brown' or 'Remove the candy'" required></textarea>
                    <div class="char-counter" id="edit-prompt-counter">200</div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary modal-close-btn" data-modal-id="edit-dialog-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="apply-edit-btn">Apply Edit</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Embedded JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE MANAGEMENT ---
            let artStyleFiles = [];
            let conceptFiles = [];
            let variationFile = null;
            let generatedDesigns = { style: [], variations: [] };
            let currentApiKey = localStorage.getItem('geminiApiKey') || '';
            let useInternalApi = true;
            let isGenerating = false;
            let currentEditId = null; // Stores the ID of the design being edited
            
            // --- CONSTANTS ---
            // NOTE: Using gemini-2.5-flash-image-preview for image generation
            const API_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent';
            const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
            const ALLOWED_MIMETYPES = ['image/png', 'image/jpeg', 'image/webp'];
            const MAX_ART_STYLES = 4;
            const MAX_CONCEPTS = 4;
            // The API key is an empty string. Canvas will automatically provide it in runtime.
            const INTERNAL_API_KEY = ""; 

            // --- DOM ELEMENT SELECTORS ---
            const app = document.getElementById('app');
            const navTabs = document.querySelectorAll('.nav-tab');
            const pages = document.querySelectorAll('.page');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const toastContainer = document.getElementById('toast-container');
            const modals = document.querySelectorAll('.modal');
            
            // Page 1: Style Transfer
            const styleUploadZone = document.getElementById('style-upload-zone');
            const styleFileInput = document.getElementById('style-file-input');
            const styleThumbnailGrid = document.getElementById('style-thumbnail-grid');
            
            const conceptUploadZone = document.getElementById('concept-upload-zone');
            const conceptFileInput = document.getElementById('concept-file-input');
            const conceptThumbnailGrid = document.getElementById('concept-thumbnail-grid');
            
            const stylePrompt = document.getElementById('style-prompt');
            const stylePromptCounter = document.getElementById('style-prompt-counter');
            const styleNumInput = document.getElementById('style-num-designs');
            const styleNumDisplay = document.getElementById('style-num-display');
            const generateStyleBtn = document.getElementById('generate-style-btn');
            const resultsGalleryStyle = document.getElementById('results-gallery-style');
            const placeholderStyle = document.getElementById('placeholder-style');
            const clearStyleBtn = document.getElementById('clear-style-btn');

            // Page 2: Variations
            const variationUploadZone = document.getElementById('variation-upload-zone');
            const variationFileInput = document.getElementById('variation-file-input');
            const variationPreview = document.getElementById('variation-preview');
            const variationPlaceholderText = document.getElementById('variation-placeholder-text');
            const variationUploadActions = document.getElementById('variation-upload-actions');
            const variationReplaceBtn = document.getElementById('variation-replace-btn');
            const variationRemoveBtn = document.getElementById('variation-remove-btn');
            
            const variationPrompt = document.getElementById('variation-prompt');
            const variationPromptCounter = document.getElementById('variation-prompt-counter');
            const variationNumInput = document.getElementById('variation-num-designs');
            const variationNumSlider = document.getElementById('variation-num-slider');
            const variationNumDisplay = document.getElementById('variation-num-display');
            const generateVariationBtn = document.getElementById('generate-variation-btn');
            const resultsGalleryVariation = document.getElementById('results-gallery-variation');
            const placeholderVariation = document.getElementById('placeholder-variation');
            const clearVariationBtn = document.getElementById('clear-variation-btn');

            // Modals
            const imageViewModal = document.getElementById('image-view-modal');
            const fullImageView = document.getElementById('full-image-view');
            const fullImageDownloadBtn = document.getElementById('full-image-download-btn');
            
            const editDialogModal = document.getElementById('edit-dialog-modal');
            const editForm = document.getElementById('edit-form');
            const editImagePreview = document.getElementById('edit-image-preview');
            const editPrompt = document.getElementById('edit-prompt');
            const editPromptCounter = document.getElementById('edit-prompt-counter');
            const applyEditBtn = document.getElementById('apply-edit-btn');

            // API Key Panels
            const apiKeyToggles = document.querySelectorAll('.api-key-toggle');
            const apiKeyInputFields = document.querySelectorAll('.api-key-input-field');

            // --- INITIALIZATION ---
            function init() {
                // Page Navigation
                navTabs.forEach(tab => {
                    tab.addEventListener('click', () => switchPage(tab.dataset.page));
                });

                // File Uploads
                setupUploadZone(styleUploadZone, styleFileInput, handleStyleFiles);
                setupUploadZone(conceptUploadZone, conceptFileInput, handleConceptFiles);
                setupUploadZone(variationUploadZone, variationFileInput, handleVariationFile);
                
                variationReplaceBtn.addEventListener('click', () => variationFileInput.click());
                variationRemoveBtn.addEventListener('click', clearVariationFile);

                // Form Controls
                setupCharCounter(stylePrompt, stylePromptCounter);
                setupCharCounter(variationPrompt, variationPromptCounter);
                setupCharCounter(editPrompt, editPromptCounter);
                
                setupNumberInput('style-num-designs', 'style-num-display');
                setupNumberInput('variation-num-designs', 'variation-num-display', 'variation-num-slider');
                
                // API Panels
                setupApiPanel('style');
                setupApiPanel('variation');

                // Generate Buttons
                generateStyleBtn.addEventListener('click', handleGenerateStyleTransfer);
                generateVariationBtn.addEventListener('click', handleGenerateVariation);

                // Clear Buttons
                clearStyleBtn.addEventListener('click', () => clearResults('style'));
                clearVariationBtn.addEventListener('click', () => clearResults('variations'));

                // Modal Controls
                app.addEventListener('click', handleAppClick); // Delegated click handler
                editForm.addEventListener('submit', handleApplyEdit);
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeAllModals();
                    }
                });

                // Initial validation check
                validateStyleForm();
                validateVariationForm();
                loadApiKey();
            }

            // --- PAGE NAVIGATION ---
            function switchPage(pageId) {
                pages.forEach(page => page.classList.toggle('active', page.id === pageId));
                navTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.page === pageId));
            }

            // --- FILE UPLOAD HANDLING ---
            function setupUploadZone(zone, input, fileHandler) {
                zone.addEventListener('click', () => input.click());
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('dragover');
                });
                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('dragover');
                });
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('dragover');
                    if (e.dataTransfer.files) {
                        fileHandler(e.dataTransfer.files);
                    }
                });
                input.addEventListener('change', (e) => {
                    if (e.target.files) {
                        fileHandler(e.target.files);
                    }
                });
            }

            // Style Transfer File Handlers
            function handleStyleFiles(files) {
                handleMultipleFiles(files, artStyleFiles, MAX_ART_STYLES, styleThumbnailGrid, 'style', validateStyleForm);
            }
            function handleConceptFiles(files) {
                handleMultipleFiles(files, conceptFiles, MAX_CONCEPTS, conceptThumbnailGrid, 'concept', validateStyleForm);
            }
            
            // Variation File Handler
            function handleVariationFile(files) {
                if (!files || files.length === 0) return;
                const file = files[0];

                if (!validateFile(file)) return;

                fileToBase64(file).then(base64 => {
                    variationFile = {
                        name: file.name,
                        type: file.type,
                        base64: base64
                    };
                    variationPreview.src = base64;
                    variationPreview.classList.remove('hidden');
                    variationPlaceholderText.classList.add('hidden');
                    variationUploadActions.classList.remove('hidden');
                    variationUploadActions.style.display = 'flex';
                    variationUploadZone.style.padding = '1rem';
                    validateVariationForm();
                }).catch(err => showToast(`Error reading file: ${err.message}`));
            }
            
            function clearVariationFile() {
                variationFile = null;
                variationPreview.src = '';
                variationPreview.classList.add('hidden');
                variationPlaceholderText.classList.remove('hidden');
                variationUploadActions.classList.add('hidden');
                variationUploadZone.style.padding = '3rem 1.5rem';
                variationFileInput.value = ''; // Reset input
                validateVariationForm();
            }

            // Multiple File Logic
            function handleMultipleFiles(files, fileArray, maxFiles, gridElement, type, validator) {
                const spaceLeft = maxFiles - fileArray.length;
                if (spaceLeft <= 0) {
                    showToast(`You can only upload a maximum of ${maxFiles} ${type} images.`);
                    return;
                }
                
                const filesToProcess = Array.from(files).slice(0, spaceLeft);
                let promises = [];
                
                for (const file of filesToProcess) {
                    if (validateFile(file)) {
                        promises.push(fileToBase64(file).then(base64 => ({
                            id: crypto.randomUUID(),
                            name: file.name,
                            type: file.type,
                            base64: base64
                        })));
                    }
                }
                
                Promise.all(promises).then(newFiles => {
                    fileArray.push(...newFiles);
                    renderThumbnails(gridElement, fileArray, type);
                    validator();
                }).catch(err => showToast(`Error reading files: ${err.message}`));
            }
            
            // Thumbnail Rendering
            function renderThumbnails(gridElement, fileArray, type) {
                gridElement.innerHTML = '';
                fileArray.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'thumbnail-item';
                    item.innerHTML = `
                        <img src="${file.base64}" alt="${file.name}">
                        <button class="remove-btn" data-id="${file.id}" data-type="${type}" aria-label="Remove ${file.name}">&times;</button>
                    `;
                    gridElement.appendChild(item);
                });
            }

            // File Validation & Conversion
            function validateFile(file) {
                if (!ALLOWED_MIMETYPES.includes(file.type)) {
                    showToast(`Invalid file type: ${file.name}. Please use JPG, PNG, or WEBP.`, 'error');
                    return false;
                }
                if (file.size > MAX_FILE_SIZE) {
                    showToast(`File is too large: ${file.name}. Max size is 5MB.`, 'error');
                    return false;
                }
                return true;
            }

            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            }

            // --- FORM CONTROL HELPERS ---
            function setupCharCounter(textarea, counterElement) {
                const maxLength = textarea.maxLength;
                textarea.addEventListener('input', () => {
                    const remaining = maxLength - textarea.value.length;
                    counterElement.textContent = remaining;
                });
            }

            function setupNumberInput(inputId, displayId, sliderId = null) {
                const input = document.getElementById(inputId);
                const display = document.getElementById(displayId);
                const slider = sliderId ? document.getElementById(sliderId) : null;
                
                const update = (value) => {
                    const min = parseInt(input.min, 10);
                    const max = parseInt(input.max, 10);
                    let validValue = Math.max(min, Math.min(max, parseInt(value, 10)));
                    if (isNaN(validValue)) validValue = min;
                    
                    input.value = validValue;
                    display.textContent = validValue;
                    if (slider) slider.value = validValue;
                };

                app.addEventListener('click', (e) => {
                    const btn = e.target.closest('.number-btn');
                    if (!btn || btn.dataset.input !== inputId) return;
                    
                    const action = btn.dataset.action;
                    let value = parseInt(input.value, 10);
                    if (action === 'increase') value++;
                    if (action === 'decrease') value--;
                    update(value);
                });
                
                input.addEventListener('change', () => update(input.value));
                if (slider) {
                    slider.addEventListener('input', () => update(slider.value));
                }
            }

            // --- API PANEL LOGIC ---
            function loadApiKey() {
                apiKeyInputFields.forEach(input => input.value = currentApiKey);
                validateApiKey(currentApiKey);
                updateApiToggle(true); // Default to internal API
            }
            
            function setupApiPanel(pagePrefix) {
                const toggle = document.getElementById(`api-key-toggle-${pagePrefix}`);
                const wrapper = document.getElementById(`api-key-wrapper-${pagePrefix}`);
                const input = document.getElementById(`api-key-input-${pagePrefix}`);

                toggle.addEventListener('change', () => {
                    useInternalApi = toggle.checked;
                    updateApiToggle(useInternalApi, pagePrefix);
                });
                
                input.addEventListener('input', () => {
                    currentApiKey = input.value;
                    localStorage.setItem('geminiApiKey', currentApiKey);
                    // Sync other input field
                    const otherPrefix = pagePrefix === 'style' ? 'variation' : 'style';
                    document.getElementById(`api-key-input-${otherPrefix}`).value = currentApiKey;
                    validateApiKey(currentApiKey);
                });
            }
            
            function updateApiToggle(isInternal, specificPrefix = null) {
                useInternalApi = isInternal;
                const prefixes = specificPrefix ? [specificPrefix] : ['style', 'variation'];
                
                prefixes.forEach(prefix => {
                    const toggle = document.getElementById(`api-key-toggle-${prefix}`);
                    const wrapper = document.getElementById(`api-key-wrapper-${prefix}`);
                    if (isInternal) {
                        wrapper.classList.remove('active');
                        if (toggle) toggle.checked = true;
                    } else {
                        wrapper.classList.add('active');
                        if (toggle) toggle.checked = false;
                    }
                });
                validateApiKey(currentApiKey); // Re-validate
            }

            function validateApiKey(key) {
                const isValid = !useInternalApi && key && key.startsWith('AIza') && key.length > 30;
                const isInternalValid = useInternalApi;

                ['style', 'variation'].forEach(prefix => {
                    const validIcon = document.getElementById(`api-key-valid-icon-${prefix}`);
                    const invalidIcon = document.getElementById(`api-key-invalid-icon-${prefix}`);
                    
                    if (isInternalValid) {
                        validIcon.style.display = 'none';
                        invalidIcon.style.display = 'none';
                    } else {
                        validIcon.style.display = isValid ? 'block' : 'none';
                        invalidIcon.style.display = isValid ? 'none' : 'block';
                    }
                });
                
                validateStyleForm();
                validateVariationForm();
                return isValid || isInternalValid;
            }

            // --- FORM VALIDATION ---
            function validateStyleForm() {
                const filesValid = artStyleFiles.length > 0 && conceptFiles.length > 0;
                const apiValid = useInternalApi || validateApiKey(currentApiKey);
                generateStyleBtn.disabled = !filesValid || !apiValid || isGenerating;
            }
            
            function validateVariationForm() {
                const fileValid = variationFile !== null;
                const apiValid = useInternalApi || validateApiKey(currentApiKey);
                generateVariationBtn.disabled = !fileValid || !apiValid || isGenerating;
            }

            // --- MAIN CLICK HANDLER (DELEGATION) ---
            function handleAppClick(e) {
                const target = e.target;
                
                // Remove thumbnail
                const removeBtn = target.closest('.remove-btn');
                if (removeBtn) {
                    const id = removeBtn.dataset.id;
                    const type = removeBtn.dataset.type;
                    
                    if (type === 'style') {
                        artStyleFiles = artStyleFiles.filter(f => f.id !== id);
                        renderThumbnails(styleThumbnailGrid, artStyleFiles, 'style');
                        validateStyleForm();
                    } else if (type === 'concept') {
                        conceptFiles = conceptFiles.filter(f => f.id !== id);
                        renderThumbnails(conceptThumbnailGrid, conceptFiles, 'concept');
                        validateStyleForm();
                    }
                    return;
                }
                
                // Modal close
                const modalCloseBtn = target.closest('.modal-close-btn') || 
                                     (target.classList.contains('modal') && !target.querySelector('.modal-content'));
                if (modalCloseBtn) {
                    const modalId = modalCloseBtn.dataset.modalId || modalCloseBtn.id;
                    closeModal(modalId);
                    return;
                }

                // Gallery actions
                const actionBtn = target.closest('[data-action]');
                if (actionBtn && actionBtn.closest('.result-card')) {
                    const card = actionBtn.closest('.result-card');
                    const id = card.dataset.id;
                    const type = card.dataset.type;
                    const action = actionBtn.dataset.action;
                    
                    const design = generatedDesigns[type].find(d => d.id === id);
                    if (!design) return;
                    
                    switch (action) {
                        case 'view':
                            openImageViewModal(design.base64);
                            break;
                        case 'edit':
                            openEditDialog(design);
                            break;
                        case 'download':
                            downloadImage(design.base64, `pod-design-${design.timestamp}.png`);
                            break;
                        case 'delete':
                            deleteDesign(id, type);
                            break;
                    }
                }
            }
            
            // --- CORE GENERATION LOGIC ---
            function getApiKey() {
                return useInternalApi ? INTERNAL_API_KEY : currentApiKey;
            }
            
            function setLoading(isLoading, count = 0) {
                isGenerating = isLoading;
                if (isLoading) {
                    loadingText.textContent = `Generating ${count} design${count > 1 ? 's' : ''}... This may take a moment.`;
                    loadingOverlay.classList.add('active');
                } else {
                    loadingOverlay.classList.remove('active');
                }
                validateStyleForm();
                validateVariationForm();
            }

            // Style Transfer Generation
            async function handleGenerateStyleTransfer() {
                const numToGenerate = parseInt(styleNumInput.value, 10);
                if (numToGenerate < 1) return;
                
                setLoading(true, numToGenerate);
                const key = getApiKey();
                const prompt = stylePrompt.value;
                
                let promises = [];
                for (let i = 0; i < numToGenerate; i++) {
                    // Combine random art style + concept for each generation
                    const randomArtStyle = artStyleFiles[Math.floor(Math.random() * artStyleFiles.length)];
                    const randomConcept = conceptFiles[Math.floor(Math.random() * conceptFiles.length)];
                    promises.push(generateStyleTransfer(randomArtStyle, randomConcept, prompt, key));
                }
                
                const results = await Promise.allSettled(promises);
                
                let newDesigns = [];
                results.forEach(result => {
                    if (result.status === 'fulfilled' && result.value) {
                        const timestamp = Date.now();
                        newDesigns.push({
                            id: crypto.randomUUID(),
                            base64: result.value,
                            prompt: prompt,
                            timestamp: timestamp
                        });
                    } else {
                        console.error("Generation failed:", result.reason);
                        showToast('One or more generations failed. Please try again.', 'error');
                    }
                });
                
                generatedDesigns.style = [...newDesigns, ...generatedDesigns.style];
                renderGallery('style');
                setLoading(false);
                if (newDesigns.length > 0) {
                     document.getElementById('results-section-style').scrollIntoView({ behavior: 'smooth' });
                }
            }
            
            // Variation Generation
            async function handleGenerateVariation() {
                const numToGenerate = parseInt(variationNumInput.value, 10);
                if (numToGenerate < 1) return;
                
                setLoading(true, numToGenerate);
                const key = getApiKey();
                const prompt = variationPrompt.value;
                
                let promises = [];
                for (let i = 0; i < numToGenerate; i++) {
                    // Add a slight variation to the prompt for each call if requested, or just run multiple times
                    let variedPrompt = prompt;
                    if (prompt.length > 0) {
                        variedPrompt = `${prompt} (Variation ${i+1})`;
                    }
                    promises.push(generateVariations(variationFile, variedPrompt, key));
                }
                
                const results = await Promise.allSettled(promises);
                
                let newDesigns = [];
                results.forEach(result => {
                    if (result.status === 'fulfilled' && result.value) {
                        const timestamp = Date.now();
                        newDesigns.push({
                            id: crypto.randomUUID(),
                            base64: result.value,
                            prompt: prompt,
                            timestamp: timestamp
                        });
                    } else {
                        console.error("Generation failed:", result.reason);
                        showToast('One or more generations failed. Please try again.', 'error');
                    }
                });
                
                generatedDesigns.variations = [...newDesigns, ...generatedDesigns.variations];
                renderGallery('variations');
                setLoading(false);
                if (newDesigns.length > 0) {
                     document.getElementById('results-section-variation').scrollIntoView({ behavior: 'smooth' });
                }
            }
            
            // Edit Generation
            async function handleApplyEdit(e) {
                e.preventDefault();
                if (!currentEditId) return;
                
                const designType = generatedDesigns.style.find(d => d.id === currentEditId) ? 'style' : 'variations';
                const originalDesign = generatedDesigns[designType].find(d => d.id === currentEditId);
                
                if (!originalDesign) {
                    showToast('Could not find original design to edit.', 'error');
                    return;
                }
                
                const editInstruction = editPrompt.value;
                if (!editInstruction) {
                    showToast('Please describe your edit.', 'error');
                    return;
                }
                
                applyEditBtn.disabled = true;
                applyEditBtn.textContent = 'Applying...';
                
                const key = getApiKey();
                
                try {
                    const editedBase64 = await editDesign(originalDesign, editInstruction, key);
                    
                    // Find and replace the design in the array
                    const designIndex = generatedDesigns[designType].findIndex(d => d.id === currentEditId);
                    if (designIndex > -1) {
                        generatedDesigns[designType][designIndex].base64 = editedBase64;
                        generatedDesigns[designType][designIndex].prompt = editInstruction; // Update prompt to reflect edit
                        generatedDesigns[designType][designIndex].timestamp = Date.now();
                    }
                    
                    renderGallery(designType);
                    closeModal('edit-dialog-modal');
                    showToast('Design edited successfully!', 'success');
                    
                } catch (error) {
                    console.error('Edit failed:', error);
                    showToast(`Edit failed: ${error.message}`, 'error');
                } finally {
                    applyEditBtn.disabled = false;
                    applyEditBtn.textContent = 'Apply Edit';
                    currentEditId = null;
                    editPrompt.value = '';
                }
            }


            // --- API FETCH FUNCTIONS ---
            
            /**
             * Performs a fetch request to the Gemini API with exponential backoff.
             */
            async function fetchWithBackoff(apiKey, payload, maxRetries = 3) {
                let delay = 1000; // 1 second
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(`${API_ENDPOINT}?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                            
                            if (base64Data) {
                                return `data:image/png;base64,${base64Data}`;
                            } else {
                                const errorText = result?.candidates?.[0]?.finishReason || 'No image data returned';
                                throw new Error(`API Error: ${errorText}`);
                            }
                        } else if (response.status === 429 || response.status >= 500) {
                            // Rate limit or server error, wait and retry
                            console.warn(`API call failed with status ${response.status}. Retrying in ${delay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                        } else {
                            // Other client-side error (e.g., 400 Bad Request, 403 Forbidden)
                            const errorResult = await response.json();
                            const message = errorResult?.error?.message || `HTTP Error: ${response.status}`;
                            if (message.includes('API key not valid')) {
                                throw new Error('API key is invalid. Please check and try again.');
                            }
                            throw new Error(message);
                        }
                    } catch (error) {
                        if (i === maxRetries - 1) {
                            // Last retry failed
                            throw error;
                        }
                        // Network error, wait and retry
                        console.warn(`Network error. Retrying in ${delay}ms...`, error);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }
                throw new Error('Generation failed after multiple retries.');
            }

            /**
             * API Call: Style Transfer
             * Combines one art style image and one concept image with a text prompt.
             */
            async function generateStyleTransfer(artStyleFile, conceptFile, prompt, apiKey) {
                const textPrompt = `
                    Task: Perform artistic style transfer.
                    1.  Use the FIRST image as the primary ART STYLE reference.
                    2.  Use the SECOND image as the structural CONCEPT reference.
                    3.  Combine them based on the following user idea: "${prompt || 'Combine the style and concept beautifully.'}"
                    
                    Generate a new, high-quality design.
                `;
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: textPrompt },
                            { inlineData: { mimeType: artStyleFile.type, data: artStyleFile.base64.split(',')[1] } },
                            { inlineData: { mimeType: conceptFile.type, data: conceptFile.base64.split(',')[1] } }
                        ]
                    }],
                    generationConfig: {
                        responseModalities: ['IMAGE']
                    }
                };
                
                return fetchWithBackoff(apiKey, payload);
            }

            /**
             * API Call: Variations
             * Creates variations of a base design, guided by a text prompt.
             */
            async function generateVariations(designFile, prompt, apiKey) {
                const textPrompt = `
                    Task: Generate a creative variation of the provided image.
                    User Idea: "${prompt || 'Create a new version of this design. Be creative.'}"
                `;
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: textPrompt },
                            { inlineData: { mimeType: designFile.type, data: designFile.base64.split(',')[1] } }
                        ]
                    }],
                    generationConfig: {
                        responseModalities: ['IMAGE']
                    }
                };
                
                return fetchWithBackoff(apiKey, payload);
            }

            /**
             * API Call: Edit Design
             * Edits an existing design based on a text prompt.
             */
            async function editDesign(originalDesign, editInstruction, apiKey) {
                const textPrompt = `
                    Task: Perform an in-painting or image edit.
                    Edit Instruction: "${editInstruction}"
                    
                    Apply this change to the provided image.
                `;
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: textPrompt },
                            { inlineData: { mimeType: 'image/png', data: originalDesign.base64.split(',')[1] } } // Assume PNG for edits
                        ]
                    }],
                    generationConfig: {
                        responseModalities: ['IMAGE']
                    }
                };
                
                return fetchWithBackoff(apiKey, payload);
            }


            // --- GALLERY & RESULTS ---
            function renderGallery(type) {
                const galleryElement = (type === 'style') ? resultsGalleryStyle : resultsGalleryVariation;
                const placeholderElement = (type === 'style') ? placeholderStyle : placeholderVariation;
                const designs = generatedDesigns[type];
                
                if (designs.length === 0) {
                    galleryElement.innerHTML = '';
                    placeholderElement.style.display = 'block';
                    return;
                }
                
                placeholderElement.style.display = 'none';
                galleryElement.innerHTML = '';
                
                designs.forEach(design => {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.dataset.id = design.id;
                    card.dataset.type = type;
                    
                    const time = new Date(design.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    card.innerHTML = `
                        <img src="${design.base64}" alt="Generated POD Design" loading="lazy">
                        <div class="overlay"></div>
                        <span class="timestamp">${time}</span>
                        <div class="actions">
                            <button class="btn-icon tooltip" data-action="view" aria-label="View full image" title="View Full">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            </button>
                            <button class="btn-icon tooltip" data-action="edit" aria-label="Edit this design" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                            </button>
                            <button class="btn-icon tooltip" data-action="download" aria-label="Download this design" title="Download">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                            </button>
                            <button class="btn-icon tooltip" data-action="delete" aria-label="Delete this design" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.56 0c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                            </button>
                        </div>
                    `;
                    galleryElement.appendChild(card);
                });
            }
            
            function deleteDesign(id, type) {
                generatedDesigns[type] = generatedDesigns[type].filter(d => d.id !== id);
                renderGallery(type);
                showToast('Design deleted.', 'success');
            }

            function clearResults(type) {
                generatedDesigns[type] = [];
                renderGallery(type);
                showToast('Gallery cleared.', 'success');
            }
            
            // --- MODAL CONTROLS ---
            function openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.add('active');
            }
            
            function closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.remove('active');
            }
            
            function closeAllModals() {
                modals.forEach(modal => modal.classList.remove('active'));
            }
            
            function openImageViewModal(base64) {
                fullImageView.src = base64;
                fullImageDownloadBtn.onclick = () => downloadImage(base64, `pod-design-${Date.now()}.png`);
                openModal('image-view-modal');
            }
            
            function openEditDialog(design) {
                currentEditId = design.id;
                editImagePreview.src = design.base64;
                editPrompt.value = '';
                editPromptCounter.textContent = '200';
                openModal('edit-dialog-modal');
            }

            // --- UTILITY FUNCTIONS ---
            
            // Show Toast Notification
            function showToast(message, type = 'error') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 5000); // Remove after 5 seconds
            }

            // Download Image
            function downloadImage(base64Data, filename) {
                const blob = base64ToBlob(base64Data);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            function base64ToBlob(base64) {
                const parts = base64.split(';base64,');
                const contentType = parts[0].split(':')[1];
                const raw = window.atob(parts[1]);
                const rawLength = raw.length;
                const uInt8Array = new Uint8Array(rawLength);
                
                for (let i = 0; i < rawLength; ++i) {
                    uInt8Array[i] = raw.charCodeAt(i);
                }
                
                return new Blob([uInt8Array], { type: contentType });
            }

            // --- START THE APP ---
            init();

        });
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Design Generator</title>
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Embedded CSS -->
    <style>
        /* CSS Reset */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ========================================
        DESIGN TOKENS & ROOT VARIABLES
        (As specified in the prompt)
        ========================================
        */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-color: #F093FB;
            --success-green: #4ade80;
            --error-red: #f87171;
            --warning-yellow: #facc15;
            --background: #fafbfc;
            --card-bg: #ffffff;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.08);
            --card-shadow-hover: 0 8px 24px rgba(0,0,0,0.12);
            --border-radius-card: 12px;
            --border-radius-button: 8px;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --upload-border: 3px dashed #e0e7ff;
            --upload-border-hover: #667eea;
            --upload-bg-hover: #f5f7ff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-light: #ffffff;
            --border-color: #e5e7eb;
            --modal-backdrop: rgba(0, 0, 0, 0.75);
        }

        /* Dark Mode Variables */
        html.dark {
            --background: #111827;
            --card-bg: #1f2937;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.2);
            --card-shadow-hover: 0 8px 24px rgba(0,0,0,0.3);
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --upload-border: 3px dashed #374151;
            --upload-border-hover: #667eea;
            --upload-bg-hover: #1f2937;
            --modal-backdrop: rgba(0, 0, 0, 0.85);
        }

        /* ========================================
        TYPOGRAPHY & BASE STYLES
        ========================================
        */
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background: var(--background);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }

        h1, h2, h3, h4 {
            font-weight: 700;
            color: var(--text-primary);
        }

        h1 { font-size: 2.25rem; }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.25rem; }

        p {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }
        a:hover {
            color: #764ba2;
        }

        /* ========================================
        APP HEADER & NAVIGATION
        ========================================
        */
        .app-header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: background 0.3s, border-color 0.3s;
        }
        html.dark .app-header {
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1600px;
            margin: 0 auto;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-gradient);
            border-radius: 8px;
            display: grid;
            place-items: center;
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
        }
        .logo-icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .mode-toggle {
            background: var(--background);
            border-radius: var(--border-radius-button);
            padding: 0.25rem;
            display: flex;
            border: 1px solid var(--border-color);
        }

        .mode-toggle-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-toggle-btn.active {
            background: var(--card-bg);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius-button);
            transition: background 0.2s, color 0.2s;
        }
        .nav-link:hover {
            background: var(--background);
            color: var(--text-primary);
        }
        .nav-link svg {
            width: 16px;
            height: 16px;
        }

        .api-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--error-red);
            margin-left: -0.25rem;
        }
        .api-status.configured {
            background: var(--success-green);
        }

        .theme-toggle {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            display: grid;
            place-items: center;
        }
        .theme-toggle:hover {
            background: var(--background);
        }
        .theme-toggle svg {
            width: 20px;
            height: 20px;
        }
        .theme-toggle .icon-sun { display: none; }
        html.dark .theme-toggle .icon-sun { display: block; }
        html.dark .theme-toggle .icon-moon { display: none; }


        /* ========================================
        MAIN CONTENT & LAYOUT
        ========================================
        */
        main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .mode-container {
            display: none; /* Hidden by default */
        }
        .mode-container.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-panels-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .upload-panel {
            background: var(--card-bg);
            border-radius: var(--border-radius-card);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
        }

        .upload-panel h2 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        /* ========================================
        UPLOAD ZONES
        (As specified in the prompt)
        ========================================
        */
        .upload-zone {
            border: var(--upload-border);
            border-radius: var(--border-radius-card);
            padding: 2rem;
            text-align: center;
            background: var(--background);
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-zone.drag-over {
            border-color: var(--upload-border-hover);
            background: var(--upload-bg-hover);
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        }
        .upload-zone:hover {
            border-color: var(--upload-border-hover);
            background: var(--upload-bg-hover);
        }

        .upload-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
            pointer-events: none; /* Allows click to pass to input */
        }
        .upload-zone-content svg {
            width: 48px;
            height: 48px;
            color: #9ca3af;
        }
        .upload-zone h3 {
            color: var(--text-primary);
        }
        .upload-zone p {
            font-size: 0.875rem;
        }
        .upload-zone input[type="file"] {
            display: none;
        }

        /* ========================================
        THUMBNAIL GRID
        ========================================
        */
        .thumbnail-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            padding: 0 0.25rem;
            min-height: 24px;
        }
        .thumbnail-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .thumbnail-actions {
            display: flex;
            gap: 0.5rem;
        }
        .thumbnail-actions .btn-secondary {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
        }

        .thumbnail-grid {
            max-height: 400px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
            padding: 1rem 0.25rem;
            border-top: 1px solid var(--border-color);
        }
        .thumbnail-grid:empty {
            display: none;
        }
        .thumbnail-grid.has-files {
            border-top: 1px solid var(--border-color);
        }

        .thumbnail {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            aspect-ratio: 1 / 1;
            opacity: 0;
            transform: scale(0.9);
            animation: scaleIn 0.3s ease-out forwards;
        }

        @keyframes scaleIn {
            to { opacity: 1; transform: scale(1); }
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .thumbnail-index {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 4px;
            line-height: 1;
        }

        .thumbnail-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 1rem;
            font-weight: 700;
            line-height: 18px;
            text-align: center;
            cursor: pointer;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s;
        }
        .thumbnail:hover .thumbnail-remove {
            opacity: 1;
            transform: scale(1);
        }
        .thumbnail-remove:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.1);
        }

        /* ========================================
        CONTROL PANEL & GENERATION
        ========================================
        */
        .control-panel {
            background: var(--card-bg);
            border-radius: var(--border-radius-card);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .optional-prompt details {
            margin-bottom: 1.5rem;
        }
        .optional-prompt summary {
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            list-style: none; /* Remove default triangle */
        }
        .optional-prompt summary::-webkit-details-marker {
            display: none; /* Chrome */
        }
        .optional-prompt summary::before {
            content: 'ðŸŽ¨';
            margin-right: 0.5rem;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 120px;
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius-button);
            border: 1px solid var(--border-color);
            background: var(--background);
            color: var(--text-primary);
            font-family: var(--font-family);
            font-size: 1rem;
            resize: vertical;
        }
        .prompt-textarea:focus {
            outline: 2px solid #667eea;
            border-color: #667eea;
        }

        .prompt-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }
        .char-counter {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .char-counter.warning { color: var(--warning-yellow); }
        .char-counter.error { color: var(--error-red); }

        .generation-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            text-align: center;
        }
        .generation-status {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .generation-status strong {
            color: var(--text-primary);
        }
        .generation-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* ========================================
        BUTTONS
        (As specified in the prompt)
        ========================================
        */
        .btn {
            padding: 0.75rem 1.25rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--border-radius-button);
            border: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        .btn svg {
            width: 18px;
            height: 18px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: var(--text-light);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:disabled {
            background: #9ca3af;
            color: #e5e7eb;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-primary.pulsing {
            animation: pulse-animation 2s infinite;
        }

        @keyframes pulse-animation {
            0% { box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
            50% { box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }
            100% { box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        }
        
        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn-secondary:hover {
            background: var(--background);
            border-color: #d1d5db;
        }

        .btn-danger {
            background: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
        }
        .btn-danger:hover {
            background: #fca5a5;
            color: #7f1d1d;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        /* ========================================
        MODE 2: VARIATIONS
        ========================================
        */
        .variation-upload-panel {
            max-width: 800px;
            margin: 0 auto 2rem auto;
        }

        .variation-config {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .form-group label {
            font-size: 1rem;
            font-weight: 600;
        }
        .form-group input[type="number"] {
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius-button);
            border: 1px solid var(--border-color);
            background: var(--background);
            color: var(--text-primary);
            font-size: 1rem;
            max-width: 150px;
        }

        /* ========================================
        RESULTS GALLERY
        (As specified in the prompt)
        ========================================
        */
        .results-gallery h2 {
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .result-card {
            background: var(--card-bg);
            box-shadow: var(--card-shadow);
            border-radius: var(--border-radius-card);
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            border: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s ease-out forwards;
        }
        .result-card:hover {
            transform: scale(1.02);
            box-shadow: var(--card-shadow-hover);
        }

        .result-card-image {
            position: relative;
            aspect-ratio: 1 / 1;
            background: #f3f4f6;
        }
        .result-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .action-buttons-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        html.dark .action-buttons-overlay {
            background: rgba(31, 41, 55, 0.9);
        }
        .result-card:hover .action-buttons-overlay {
            opacity: 1;
        }

        .action-buttons-overlay .btn {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
            flex-direction: column;
            gap: 0.25rem;
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .action-buttons-overlay .btn svg {
            width: 16px;
            height: 16px;
        }
        .action-buttons-overlay .btn:hover {
            background: var(--background);
        }
        
        .result-card-footer {
            padding: 1rem;
        }
        .result-card-niche {
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }
        .result-card-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .result-card-time {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .result-card-fav {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .result-card-fav svg {
            width: 20px;
            height: 20px;
        }
        .result-card-fav.favorited {
            color: var(--warning-yellow);
        }
        .result-card-fav.favorited svg {
            fill: var(--warning-yellow);
        }

        /* ========================================
        MODALS
        ========================================
        */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            background: var(--modal-backdrop);
        }
        .modal.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }
        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius-card);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            padding: 2rem;
            animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--background);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.25rem;
            line-height: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: var(--error-red);
            color: white;
            border-color: var(--error-red);
            transform: rotate(90deg);
        }
        .modal-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .modal-header h2 {
            font-size: 1.5rem;
        }
        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .modal-body .form-group {
            width: 100%;
        }
        .modal-body label {
            font-weight: 600;
            font-size: 0.875rem;
        }
        .modal-body input[type="password"],
        .modal-body input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius-button);
            border: 1px solid var(--border-color);
            background: var(--background);
            color: var(--text-primary);
            font-size: 1rem;
        }
        .modal-body .info-box {
            background: var(--background);
            border-radius: var(--border-radius-button);
            padding: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        .modal-body .info-box p {
            margin-bottom: 0.5rem;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        .api-test-result {
            font-size: 0.875rem;
            font-weight: 500;
            flex-grow: 1;
        }
        .api-test-result.success { color: var(--success-green); }
        .api-test-result.error { color: var(--error-red); }

        /* Image Viewer Modal */
        #image-viewer-modal .modal-content {
            background: transparent;
            box-shadow: none;
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #image-viewer-modal .modal-close {
            top: 2rem;
            right: 2rem;
            z-index: 2002;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        #image-viewer-modal .modal-close:hover {
            background: var(--error-red);
        }
        .image-viewer-container {
            width: 100%;
            height: 100%;
            display: grid;
            place-items: center;
            overflow: hidden;
            position: relative;
        }
        .image-viewer-img {
            max-width: 90vw;
            max-height: 80vh;
            object-fit: contain;
            cursor: grab;
            transition: transform 0.2s ease-out;
        }
        .image-viewer-img.zoomed {
            cursor: move;
        }

        .image-viewer-controls {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius-button);
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 2001;
        }
        .image-viewer-controls .btn-icon {
            background: var(--card-bg);
            color: var(--text-primary);
        }
        .image-viewer-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 1rem;
            pointer-events: none;
            z-index: 2001;
        }
        .image-viewer-nav .btn-icon {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            pointer-events: auto;
        }
        
        /* Edit Modal */
        #edit-design-modal .modal-content {
            max-width: 800px;
        }
        .edit-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .edit-preview-box {
            aspect-ratio: 1/1;
            background: var(--background);
            border-radius: var(--border-radius-button);
            border: 1px solid var(--border-color);
            display: grid;
            place-items: center;
            position: relative;
        }
        .edit-preview-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .edit-preview-box::before {
            content: attr(data-label);
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--card-bg);
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
        }

        /* ========================================
        LOADING & FEEDBACK STATES
        ========================================
        */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }
        #loading-overlay.active {
            display: flex;
        }
        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 2rem 3rem;
            border-radius: var(--border-radius-card);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-status {
            font-size: 1rem;
            font-weight: 500;
        }
        #loading-progress {
            font-size: 1.25rem;
            font-weight: 700;
        }

        #toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 4000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .toast {
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: var(--border-radius-button);
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-left: 5px solid;
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        .toast.success { border-color: var(--success-green); }
        .toast.error { border-color: var(--error-red); }
        .toast.warning { border-color: var(--warning-yellow); }

        .toast-icon {
            font-size: 1.25rem;
        }
        .toast.success .toast-icon { color: var(--success-green); }
        .toast.error .toast-icon { color: var(--error-red); }
        .toast.warning .toast-icon { color: var(--warning-yellow); }

        /* ========================================
        RESPONSIVE DESIGN
        (As specified in the prompt)
        ========================================
        */
        
        /* Tablet: < 1024px */
        @media (max-width: 1024px) {
            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            .header-content {
                gap: 0.5rem;
            }
            .logo h1 {
                font-size: 1.25rem;
            }
            main {
                padding: 1.5rem;
            }
            .thumbnail-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }

        /* Mobile: < 768px */
        @media (max-width: 768px) {
            .app-header {
                padding: 1rem;
                position: static;
            }
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-nav {
                width: 100%;
                justify-content: space-between;
                margin-top: 0.5rem;
            }
            main {
                padding: 1rem;
            }
            .upload-panels-container {
                grid-template-columns: 1fr;
            }
            .mode-toggle {
                width: 100%;
            }
            .mode-toggle-btn {
                flex-grow: 1;
            }
            .results-grid {
                grid-template-columns: 1fr;
            }
            .thumbnail-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                max-height: 250px;
            }
            .modal-content {
                width: 95%;
                padding: 1.5rem;
                max-height: 95vh;
            }
            #toast-container {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                width: auto;
            }
            .edit-preview {
                grid-template-columns: 1fr;
            }
        }

        /* Utility */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <!-- App Container -->
    <div id="app">

        <!-- ======================= -->
        <!-- App Header              -->
        <!-- ======================= -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.405 1.05c.42-.42 1.14-.42 1.56 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25ZM3.5 12.5a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5a.75.75 0 0 1 .75-.75Zm11.5 0a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 15 12.5Z"/></svg>
                    </div>
                    <h1>AI Design Generator</h1>
                </div>

                <div class="mode-toggle">
                    <button class="mode-toggle-btn active" data-mode="normal">Normal Mode</button>
                    <button class="mode-toggle-btn" data-mode="variations">Generate Variations</button>
                </div>

                <nav class="header-nav">
                    <a href="#" class="nav-link" id="my-designs-link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H4Zm12 12H4V5h12v10ZM6 8a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-1.5 0v-4.5A.75.75 0 0 1 6 8Zm4-1.25a.75.75 0 0 1 .75.75v7.5a.75.75 0 0 1-1.5 0v-7.5a.75.75 0 0 1 .75-.75Zm4 .75a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-1.5 0v-4.5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" /></svg>
                        My AI Designs
                    </a>
                    <button class="nav-link" id="api-settings-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.013 2.513a.75.75 0 0 1 .525.965l-1.026 4.104A3.5 3.5 0 0 1 10 11.5a3.5 3.5 0 0 1-2.903-5.432L7.38 2.802a.75.75 0 0 1 .965-.525l2.668.236ZM10 12.5a4.5 4.5 0 0 0 4.135-6.046l1.34 5.358a.75.75 0 0 1-.525.965l-2.668.236a.75.75 0 0 1-.61-.12l-1.74-1.74A4.5 4.5 0 0 0 10 12.5Z" clip-rule="evenodd" /><path d="m1.69 16.309 1.12 4.479a.75.75 0 0 0 .965.525l2.668-.236a.75.75 0 0 0 .61-.12l1.74-1.74a4.5 4.5 0 0 0 2.414 0l1.74 1.74a.75.75 0 0 0 .61.12l2.668.236a.75.75 0 0 0 .965-.525l1.12-4.479a.75.75 0 0 0-.525-.965l-2.668-.236a.75.75 0 0 0-.61.12l-1.74 1.74a4.502 4.502 0 0 1-4.828 0l-1.74-1.74a.75.75 0 0 0-.61-.12l-2.668.236a.75.75 0 0 0-.525.965Z" /></svg>
                        API Settings
                        <span id="api-status-indicator" class="api-status"></span>
                    </button>
                    <button class="theme-toggle" id="theme-toggle-btn" title="Toggle dark mode">
                        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.455 2.004a.75.75 0 0 1 .26.75a7.5 7.5 0 0 0 9.958 7.958a.75.75 0 0 1 .961-.26a8.25 8.25 0 0 1-2.476 5.375a8.25 8.25 0 0 1-10.748-2.476A8.25 8.25 0 0 1 5.375 2.476a8.25 8.25 0 0 1 2.08-1.222a.75.75 0 0 1 .75.75Zm2.038 2.038a5.5 5.5 0 0 0 7.424 7.424A5.5 5.5 0 0 0 9.493 4.042Z" clip-rule="evenodd" /></svg>
                        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 10 2ZM10 15a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 10 15ZM10 5.5a4.5 4.5 0 1 0 0 9 4.5 4.5 0 0 0 0-9ZM10 4a6 6 0 1 1 0 12 6 6 0 0 1 0-12ZM2 10a.75.75 0 0 1-.75-.75h-1.5a.75.75 0 0 1 0-1.5h1.5A.75.75 0 0 1 2 10ZM15 10a.75.75 0 0 1-.75-.75h-1.5a.75.75 0 0 1 0-1.5h1.5A.75.75 0 0 1 15 10ZM17.662 3.088a.75.75 0 0 1 .53 1.28l-1.06 1.06a.75.75 0 0 1-1.06-1.06l1.06-1.06a.75.75 0 0 1 .53-.22ZM6.34 14.717a.75.75 0 0 1 .53 1.28l-1.06 1.06a.75.75 0 1 1-1.06-1.06l1.06-1.06a.75.75 0 0 1 .53-.22ZM17.662 16.912a.75.75 0 0 1-1.06.002l-1.06-1.06a.75.75 0 1 1 1.06-1.06l1.06 1.06a.75.75 0 0 1 0 1.058ZM6.34 5.283a.75.75 0 0 1-1.06.002l-1.06-1.06A.75.75 0 0 1 5.28 3.165l1.06 1.06a.75.75 0 0 1 0 1.058Z" /></svg>
                    </button>
                </nav>
            </div>
        </header>

        <!-- ======================= -->
        <!-- Main Content Area       -->
        <!-- ======================= -->
        <main>
            <!-- Mode 1: Normal (Style Transfer) -->
            <div id="mode-normal" class="mode-container active">
                <div class="upload-panels-container">
                    <!-- Art Style Panel -->
                    <div class="upload-panel" id="style-upload-panel">
                        <h2>ðŸŽ¨ Art Style Images</h2>
                        <div class="upload-zone" id="style-drop-zone">
                            <input type="file" id="style-file-input" multiple accept="image/png, image/jpeg, image/webp">
                            <div class="upload-zone-content">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M9.25 13.25a.75.75 0 0 0 1.5 0V4.636l2.955 3.129a.75.75 0 0 0 1.09-1.03l-4.25-4.5a.75.75 0 0 0-1.09 0l-4.25 4.5a.75.75 0 0 0 1.09 1.03L9.25 4.636v8.614Z" />
                                  <path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5a1.25 1.25 0 0 1-1.25 1.25H4.75A1.25 1.25 0 0 1 3.5 15.25v-2.5Z" />
                                </svg>
                                <h3>Drag & Drop Art Styles</h3>
                                <p>or click to browse (max 50)</p>
                                <p class="file-types">PNG, JPG, WEBP</p>
                            </div>
                        </div>
                        <div class="thumbnail-controls">
                            <span class="thumbnail-info" id="style-upload-info">0/50 images uploaded</span>
                            <div class="thumbnail-actions">
                                <button class="btn btn-secondary" data-action="select-all" data-target="style">Select All</button>
                                <button class="btn btn-danger" data-action="delete-selected" data-target="style">Delete</button>
                            </div>
                        </div>
                        <div class="thumbnail-grid" id="style-thumbnail-grid"></div>
                    </div>
                    <!-- Niche Design Panel -->
                    <div class="upload-panel" id="niche-upload-panel">
                        <h2>ðŸ‘• Niche Design Images</h2>
                        <div class="upload-zone" id="niche-drop-zone">
                            <input type="file" id="niche-file-input" multiple accept="image/png, image/jpeg, image/webp">
                            <div class="upload-zone-content">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M9.25 13.25a.75.75 0 0 0 1.5 0V4.636l2.955 3.129a.75.75 0 0 0 1.09-1.03l-4.25-4.5a.75.75 0 0 0-1.09 0l-4.25 4.5a.75.75 0 0 0 1.09 1.03L9.25 4.636v8.614Z" />
                                  <path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5a1.25 1.25 0 0 1-1.25 1.25H4.75A1.25 1.25 0 0 1 3.5 15.25v-2.5Z" />
                                </svg>
                                <h3>Drag & Drop Niche Designs</h3>
                                <p>or click to browse (max 50)</p>
                                <p class="file-types">PNG, JPG, WEBP</p>
                            </div>
                        </div>
                        <div class="thumbnail-controls">
                            <span class="thumbnail-info" id="niche-upload-info">0/50 images uploaded</span>
                            <div class="thumbnail-actions">
                                <button class="btn btn-secondary" data-action="select-all" data-target="niche">Select All</button>
                                <button class="btn btn-danger" data-action="delete-selected" data-target="niche">Delete</button>
                            </div>
                        </div>
                        <div class="thumbnail-grid" id="niche-thumbnail-grid"></div>
                    </div>
                </div>

                <!-- Control Panel -->
                <div class="control-panel">
                    <div class="optional-prompt">
                        <details>
                            <summary>Add Your Ideas (Optional)</summary>
                            <textarea id="normal-prompt" class="prompt-textarea" placeholder="Tell AI what you want. Leave empty for automatic."></textarea>
                            <div class="prompt-footer">
                                <button class="btn btn-secondary" id="normal-magic-enhance">âœ¨ Magic Enhance</button>
                                <span class="char-counter" id="normal-char-counter">0/500</span>
                            </div>
                        </details>
                    </div>
                    <div class="generation-controls">
                        <p class="generation-status" id="normal-generation-status">Ready to generate <strong>0 designs</strong></p>
                        <p class="generation-info" id="normal-generation-info">Estimated time: ~0s | Est. cost: ~$0.00</p>
                        <button class="btn btn-primary" id="generate-normal-btn" disabled style="padding: 1.25rem 2.5rem; font-size: 1.25rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="m10.893 2.164.331.662 1.326 2.651 2.651 1.326.662.331-.662.331-2.651 1.326-1.326 2.651-.331.662-.331-.662-1.326-2.651-2.651-1.326-.662-.331.662-.331 2.651-1.326 1.326-2.651.331-.662Zm-5.32 7.291.564.282 1.128.564.282.564.564 1.128.282.564-.282.564-.564 1.128-.282.564-1.128.564-.564.282-.564-.282-1.128-.564-.282-.564-.564-1.128-.282-.564.282-.564.564-1.128.282-.564 1.128-.564.564-.282Zm10.156 3.393.282.564.564 1.128.282.564-.282.564-.564 1.128-.282.564-1.128.564-.564.282-.564-.282-1.128-.564-.282-.564-.564-1.128-.282-.564.282-.564.564-1.128.282-.564 1.128-.564.564-.282Z" /></svg>
                            Generate Designs
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mode 2: Generate Variations -->
            <div id="mode-variations" class="mode-container">
                <!-- Single Upload Panel -->
                <div class="upload-panel variation-upload-panel" id="variation-upload-panel">
                    <h2>âœ¨ Upload Single Design to Vary</h2>
                    <div class="upload-zone" id="variation-drop-zone">
                        <input type="file" id="variation-file-input" accept="image/png, image/jpeg, image/webp">
                        <div class="upload-zone-content">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M9.25 13.25a.75.75 0 0 0 1.5 0V4.636l2.955 3.129a.75.75 0 0 0 1.09-1.03l-4.25-4.5a.75.75 0 0 0-1.09 0l-4.25 4.5a.75.75 0 0 0 1.09 1.03L9.25 4.636v8.614Z" />
                              <path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5a1.25 1.25 0 0 1-1.25 1.25H4.75A1.25 1.25 0 0 1 3.5 15.25v-2.5Z" />
                            </svg>
                            <h3>Drag & Drop Source Design</h3>
                            <p>or click to browse</p>
                        </div>
                    </div>
                    <div class="thumbnail-controls">
                        <span class="thumbnail-info" id="variation-upload-info">No image uploaded</span>
                        <div class="thumbnail-actions">
                            <!-- Actions for single image are on thumbnail -->
                        </div>
                    </div>
                    <div class="thumbnail-grid" id="variation-thumbnail-grid"></div>
                </div>

                <!-- Control Panel -->
                <div class="control-panel">
                    <div class="variation-config">
                        <div class="form-group">
                            <label for="variation-count">Number of Variations</label>
                            <input type="number" id="variation-count" class="prompt-textarea" value="5" min="1" max="50">
                        </div>
                    </div>
                    <div class="optional-prompt">
                        <details>
                            <summary>Add Your Ideas (Optional)</summary>
                            <textarea id="variation-prompt" class="prompt-textarea" placeholder="e.g., 'only change the animal', 'keep the pose'"></textarea>
                            <div class="prompt-footer">
                                <button class="btn btn-secondary" id="variation-magic-enhance">âœ¨ Magic Enhance</button>
                                <span class="char-counter" id="variation-char-counter">0/500</span>
                            </div>
                        </details>
                    </div>
                    <div class="generation-controls">
                        <p class="generation-status" id="variation-generation-status">Ready to generate <strong>5 variations</strong></p>
                        <p class="generation-info" id="variation-generation-info">Estimated time: ~0s | Est. cost: ~$0.00</p>
                        <button class="btn btn-primary" id="generate-variations-btn" disabled style="padding: 1.25rem 2.5rem; font-size: 1.25rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="m10.893 2.164.331.662 1.326 2.651 2.651 1.326.662.331-.662.331-2.651 1.326-1.326 2.651-.331.662-.331-.662-1.326-2.651-2.651-1.326-.662-.331.662-.331 2.651-1.326 1.326-2.651.331-.662Zm-5.32 7.291.564.282 1.128.564.282.564.564 1.128.282.564-.282.564-.564 1.128-.282.564-1.128.564-.564.282-.564-.282-1.128-.564-.282-.564-.564-1.128-.282-.564.282-.564.564-1.128.282-.564 1.128-.564.564-.282Zm10.156 3.393.282.564.564 1.128.282.564-.282.564-.564 1.128-.282.564-1.128.564-.564.282-.564-.282-1.128-.564-.282-.564-.564-1.128-.282-.564.282-.564.564-1.128.282-.564 1.128-.564.564-.282Z" /></svg>
                            Generate Variations
                        </button>
                    </div>
                </div>
            </div>

            <!-- ======================= -->
            <!-- Results Gallery         -->
            <!-- ======================= -->
            <section class="results-gallery" id="results-gallery-container">
                <h2>My AI Designs</h2>
                <div class="results-grid" id="results-grid">
                    <!-- Result cards will be injected here by JS -->
                </div>
            </section>

        </main>
    </div>

    <!-- ======================= -->
    <!-- Modals                  -->
    <!-- ======================= -->

    <!-- API Settings Modal -->
    <div id="api-settings-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" data-dismiss="modal">&times;</button>
            <div class="modal-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.013 2.513a.75.75 0 0 1 .525.965l-1.026 4.104A3.5 3.5 0 0 1 10 11.5a3.5 3.5 0 0 1-2.903-5.432L7.38 2.802a.75.75 0 0 1 .965-.525l2.668.236ZM10 12.5a4.5 4.5 0 0 0 4.135-6.046l1.34 5.358a.75.75 0 0 1-.525.965l-2.668.236a.75.75 0 0 1-.61-.12l-1.74-1.74A4.5 4.5 0 0 0 10 12.5Z" clip-rule="evenodd" /><path d="m1.69 16.309 1.12 4.479a.75.75 0 0 0 .965.525l2.668-.236a.75.75 0 0 0 .61-.12l1.74-1.74a4.5 4.5 0 0 0 2.414 0l1.74 1.74a.75.75 0 0 0 .61.12l2.668.236a.75.75 0 0 0 .965-.525l1.12-4.479a.75.75 0 0 0-.525-.965l-2.668-.236a.75.75 0 0 0-.61.12l-1.74 1.74a4.502 4.502 0 0 1-4.828 0l-1.74-1.74a.75.75 0 0 0-.61-.12l-2.668.236a.75.75 0 0 0-.525.965Z" /></svg>
                <h2>Gemini API Configuration</h2>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    <p>Get your API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>. New users may receive free credits.</p>
                    <p>Your API key is encrypted with AES-GCM and stored <strong>only on your local device</strong> in IndexedDB. It is never sent to any server except Google's.</p>
                </div>
                <div class="form-group">
                    <label for="api-key-input">Gemini API Key</label>
                    <input type="password" id="api-key-input" placeholder="AIxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                </div>
                <div id="api-test-result" class="api-test-result"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="api-key-test">Test Key</button>
                <button class="btn btn-danger" id="api-key-clear">Clear</button>
                <button class="btn btn-primary" id="api-key-save">Save & Close</button>
            </div>
        </div>
    </div>

    <!-- Full-Screen Image Viewer Modal -->
    <div id="image-viewer-modal" class="modal">
        <button class="modal-close" data-dismiss="modal">&times;</button>
        <div class="image-viewer-nav">
            <button class="btn btn-icon" id="viewer-prev">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 0 1-.02 1.06L8.832 10l3.938 3.71a.75.75 0 1 1-1.04 1.08l-4.5-4.25a.75.75 0 0 1 0-1.08l4.5-4.25a.75.75 0 0 1 1.06.02Z" clip-rule="evenodd" /></svg>
            </button>
            <button class="btn btn-icon" id="viewer-next">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 0 1 .02-1.06L11.168 10 7.23 6.29a.75.75 0 1 1 1.04-1.08l4.5 4.25a.75.75 0 0 1 0 1.08l-4.5 4.25a.75.75 0 0 1-1.06-.02Z" clip-rule="evenodd" /></svg>
            </button>
        </div>
        <div class="image-viewer-container" id="image-viewer-container">
            <img src="" alt="Full-size design" class="image-viewer-img" id="viewer-img">
        </div>
        <div class="image-viewer-controls">
            <button class="btn btn-icon" id="viewer-zoom-out" title="Zoom Out (-)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 10Z" clip-rule="evenodd" /></svg>
            </button>
            <button class="btn btn-icon" id="viewer-zoom-in" title="Zoom In (+)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
            </button>
            <button class="btn btn-icon" id="viewer-zoom-reset" title="Reset Zoom (0)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.28 4.72a.75.75 0 0 1 0 1.06l-1.06 1.06a.75.75 0 0 1-1.06-1.06l1.06-1.06a.75.75 0 0 1 1.06 0ZM4.72 4.72a.75.75 0 0 1 1.06 0l1.06 1.06a.75.75 0 1 1-1.06 1.06L4.72 5.78a.75.75 0 0 1 0-1.06ZM15.28 15.28a.75.75 0 0 1-1.06 0l-1.06-1.06a.75.75 0 1 1 1.06-1.06l1.06 1.06a.75.75 0 0 1 0 1.06ZM4.72 15.28a.75.75 0 0 1 0-1.06l1.06-1.06a.75.75 0 1 1 1.06 1.06L5.78 15.28a.75.75 0 0 1-1.06 0ZM10 3a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 10 3ZM10 15a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 10 15ZM3 10a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5h-1.5A.75.75 0 0 1 3 10ZM15 10a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5h-1.5A.75.75 0 0 1 15 10Z" clip-rule="evenodd" /></svg>
            </button>
            <button class="btn btn-icon" id="viewer-download" title="Download (D)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" /><path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5a1.25 1.25 0 0 1-1.25 1.25H4.75A1.25 1.25 0 0 1 3.5 15.25v-2.5Z" /></svg>
            </button>
            <button class="btn btn-icon" id="viewer-edit" title="Edit (E)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="m13.586 3.586.47.47.043.043L16 6l-1 1-2.5-2.5 1-1 1.854 1.854.146.146.043.043Zm-2.35 2.35L13.5 8l-6.146 6.146a.75.75 0 0 1-.32.176l-3 1a.75.75 0 0 1-.885-.885l1-3a.75.75 0 0 1 .176-.32L11.236 5.936Z" /></svg>
            </button>
        </div>
    </div>

    <!-- Edit Design Modal -->
    <div id="edit-design-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" data-dismiss="modal">&times;</button>
            <div class="modal-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="m13.586 3.586.47.47.043.043L16 6l-1 1-2.5-2.5 1-1 1.854 1.854.146.146.043.043Zm-2.35 2.35L13.5 8l-6.146 6.146a.75.75 0 0 1-.32.176l-3 1a.75.75 0 0 1-.885-.885l1-3a.75.75 0 0 1 .176-.32L11.236 5.936Z" /></svg>
                <h2>Edit Design</h2>
            </div>
            <div class="modal-body">
                <div class="edit-preview">
                    <div class="edit-preview-box" data-label="Original">
                        <img id="edit-original-img" src="">
                    </div>
                    <div class="edit-preview-box" data-label="New">
                        <img id="edit-new-img" src="">
                        <!-- Add skeleton loader here -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-prompt-input">Modification Prompt</label>
                    <textarea id="edit-prompt-input" class="prompt-textarea" placeholder="e.g., 'Change the color from gray to brown', 'Remove the candy'"></textarea>
                </div>
                <div class="info-box">
                    <strong>Examples:</strong>
                    <ul>
                        <li>"Make the background transparent"</li>
                        <li>"Change the cat's fur to orange"</li>
                        <li>"Add a Santa hat on the dog"</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="regenerate-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="m10.893 2.164.331.662 1.326 2.651 2.651 1.326.662.331-.662.331-2.651 1.326-1.326 2.651-.331.662-.331-.662-1.326-2.651-2.651-1.326-.662-.331.662-.331 2.651-1.326 1.326-2.651.331-.662Zm-5.32 7.291.564.282 1.128.564.282.564.564 1.128.282.564-.282.564-.564 1.128-.282.564-1.128.564-.564.282-.564-.282-1.128-.564-.282-.564-.564-1.128-.282-.564.282-.564.564-1.128.282-.564 1.128-.564.564-.282Zm10.156 3.393.282.564.564 1.128.282.564-.282.564-.564 1.128-.282.564-1.128.564-.564.282-.564-.282-1.128-.564-.282-.564-.564-1.128-.282-.564.282-.564.564-1.128.282-.564 1.128-.564.564-.282Z" /></svg>
                    Regenerate
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-delete-modal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <button class="modal-close" data-dismiss="modal">&times;</button>
            <div class="modal-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="color: var(--error-red);">
                    <path fill-rule="evenodd" d="M8.485 2.495c.646-1.119 2.384-1.119 3.03 0l6.29 10.894c.646 1.119-.28 2.505-1.515 2.505H3.71c-1.235 0-2.16-1.386-1.515-2.505l6.29-10.894ZM10 12.5a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-1.5 0v-.008a.75.75 0 0 1 .75-.75Zm.002-4a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0v-2.25a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                </svg>
                <h2>Confirm Deletion</h2>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to permanently delete this design? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>


    <!-- ======================= -->
    <!-- Global Feedback         -->
    <!-- ======================= -->

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3 id="loading-progress">Generating...</h3>
            <p id="loading-status">Please wait while the AI creates your designs.</p>
            <button classs="btn btn-secondary" id="cancel-generation-btn">Cancel</button>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toast-container"></div>


    <!-- ======================= -->
    <!-- Embedded JavaScript     -->
    <!-- ======================= -->
    <script type="module">
        // Strict mode for better error handling
        'use strict';

        /**
         * ----------------------------------------------------------------
         * AI Design Generator Application
         * ----------------------------------------------------------------
         * This script contains all the logic for the AI Design Generator,
         * including UI, state management, IndexedDB, cryptography,
         * image processing, and API communication.
         */

        // ================================================================
        // APP STATE & CONSTANTS
        // ================================================================

        const appState = {
            currentMode: 'normal', // 'normal' or 'variations'
            apiKey: null,
            styleFiles: [], // { id, file, base64, preprocessedB64, selected }
            nicheFiles: [], // { id, file, base64, preprocessedB64, selected }
            variationFile: null, // { id, file, base64, preprocessedB64 }
            generatedDesigns: [], // { id, image, niche, prompt, mode, favorite, createdAt }
            db: null,
            isEncrypting: false,
            currentJobId: null,
            activeModal: null,
            viewerState: {
                currentIndex: 0,
                currentId: null,
                zoom: 1,
                isDragging: false,
                lastX: 0,
                lastY: 0,
                offsetX: 0,
                offsetY: 0
            },
            editState: {
                designId: null,
                originalImage: null,
            }
        };

        const CONSTANTS = {
            DB_NAME: 'AIDesignGeneratorDB',
            DB_VERSION: 1,
            API_KEY_ID: 'gemini_api_key',
            MAX_FILES: 50,
            GRAY_BACKGROUND: '#808080',
            // API URLs are now dynamic, see getApiUrlText() and getApiUrlImage()
            API_KEY_SALT: 'ai_design_generator_v1'
        };

        // ================================================================
        // DYNAMIC API URLS
        // ================================================================

        /**
         * Returns the correct text generation API URL based on API key presence.
         * Uses "paid" model if key exists, otherwise "free/preview" model.
         * @returns {string} The Gemini API URL.
         */
        const getApiUrlText = () => {
            if (appState.apiKey) {
                // Paid/Pro model (as requested in original prompt)
                return `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent`;
            }
            // Free/Preview model (default Canvas)
            return `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;
        };

        /**
         * Returns the correct image generation API URL based on API key presence.
         * Uses "paid" model if key exists, otherwise "free/preview" model.
         * @returns {string} The Gemini API URL.
         */
        const getApiUrlImage = () => {
            if (appState.apiKey) {
                // Paid/Pro model (as requested in original prompt)
                return `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent`;
            }
            // Free/Preview model ("Nano Banana")
            return `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent`;
        };

        // ================================================================
        // DOM ELEMENT SELECTORS
        // ================================================================
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const DOMElements = {
            app: $('#app'),
            header: $('.app-header'),
            modeToggleButtons: $$('.mode-toggle-btn'),
            apiSettingsBtn: $('#api-settings-btn'),
            apiStatusIndicator: $('#api-status-indicator'),
            myDesignsLink: $('#my-designs-link'),
            themeToggleBtn: $('#theme-toggle-btn'),

            // Modes
            modeNormal: $('#mode-normal'),
            modeVariations: $('#mode-variations'),

            // Normal Mode
            styleDropZone: $('#style-drop-zone'),
            styleFileInput: $('#style-file-input'),
            styleUploadInfo: $('#style-upload-info'),
            styleThumbnailGrid: $('#style-thumbnail-grid'),
            nicheDropZone: $('#niche-drop-zone'),
            nicheFileInput: $('#niche-file-input'),
            nicheUploadInfo: $('#niche-upload-info'),
            nicheThumbnailGrid: $('#niche-thumbnail-grid'),
            normalPrompt: $('#normal-prompt'),
            normalCharCounter: $('#normal-char-counter'),
            normalGenStatus: $('#normal-generation-status'),
            normalGenInfo: $('#normal-generation-info'),
            normalGenBtn: $('#generate-normal-btn'),

            // Variations Mode
            variationDropZone: $('#variation-drop-zone'),
            variationFileInput: $('#variation-file-input'),
            variationUploadInfo: $('#variation-upload-info'),
            variationThumbnailGrid: $('#variation-thumbnail-grid'),
            variationCountInput: $('#variation-count'),
            variationPrompt: $('#variation-prompt'),
            variationCharCounter: $('#variation-char-counter'),
            variationGenStatus: $('#variation-generation-status'),
            variationGenInfo: $('#variation-generation-info'),
            variationGenBtn: $('#generate-variations-btn'),

            // Results
            resultsGallery: $('#results-gallery-container'),
            resultsGrid: $('#results-grid'),

            // Modals
            apiSettingsModal: $('#api-settings-modal'),
            apiKeyInput: $('#api-key-input'),
            apiKeySaveBtn: $('#api-key-save'),
            apiKeyClearBtn: $('#api-key-clear'),
            apiKeyTestBtn: $('#api-key-test'),
            apiTestResult: $('#api-test-result'),
            
            imageViewerModal: $('#image-viewer-modal'),
            viewerContainer: $('#image-viewer-container'),
            viewerImg: $('#viewer-img'),
            viewerPrevBtn: $('#viewer-prev'),
            viewerNextBtn: $('#viewer-next'),
            viewerZoomInBtn: $('#viewer-zoom-in'),
            viewerZoomOutBtn: $('#viewer-zoom-out'),
            viewerZoomResetBtn: $('#viewer-zoom-reset'),
            viewerDownloadBtn: $('#viewer-download'),
            viewerEditBtn: $('#viewer-edit'),

            editDesignModal: $('#edit-design-modal'),
            editOriginalImg: $('#edit-original-img'),
            editNewImg: $('#edit-new-img'),
            editPromptInput: $('#edit-prompt-input'),
            regenerateBtn: $('#regenerate-btn'),

            confirmDeleteModal: $('#confirm-delete-modal'),
            confirmDeleteBtn: $('#confirm-delete-btn'),

            // Global Feedback
            loadingOverlay: $('#loading-overlay'),
            loadingProgress: $('#loading-progress'),
            loadingStatus: $('#loading-status'),
            cancelGenerationBtn: $('#cancel-generation-btn'),
            toastContainer: $('#toast-container'),
        };

        // ================================================================
        // AI SYSTEM PROMPTS (From Request)
        // ================================================================

        /**
         * System prompt for analyzing a design (Stage 2).
         * Note: This is a simplified version for client-side text-only analysis.
         */
        const ANALYSIS_PROMPT_SYSTEM = `Analyze this t-shirt/POD design in detail based on the user's description. Extract:
- Art style (cartoon, realistic, vintage, minimalist, etc.)
- Colors (dominant palette)
- Text content (exact words if present, word count)
- Main subject/symbol
- Visual mood and tone
- Target audience
- Emotional appeal
- Commercial selling points
Provide a comprehensive description for generating variations.`;
        
        // This is the *exact* massive prompt from the user request.
        const VARIATION_GENERATION_SYSTEM_PROMPT = (userCustomPrompt = "") => {
            return `${userCustomPrompt ? `ðŸš¨ðŸš¨ðŸš¨ CRITICAL USER REQUIREMENTS - HIGHEST PRIORITY ðŸš¨ðŸš¨ðŸš¨
The user has specified MANDATORY requirements that you MUST follow EXACTLY:
"${userCustomPrompt}"
âš ï¸ IMPORTANT RULES:
1. These user requirements are MORE IMPORTANT than any other instructions below
2. If user wants to keep something unchanged (like hand gestures, pose, etc.), you MUST keep it EXACTLY the same in ALL variations
3. If user specifies what should change, ONLY change those elements
4. If user says "without character reference", do NOT change the character at all - only change what they explicitly ask for
5. User requirements OVERRIDE the default variation strategy below
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
` : ''}
You are a PROFESSIONAL t-shirt design market analyst with 10+ years of experience. Your expertise is understanding WHY designs sell and creating profitable variations.

ðŸ” PHASE 1: DEEP MARKET ANALYSIS (CRITICAL FIRST STEP!)
**STEP 1: INITIAL OBSERVATION (LOOK AT THE ACTUAL DESIGN!)**
- ðŸš¨ CRITICAL FIRST: Does this design have TEXT or is it IMAGE-ONLY? (Look carefully!)
- If it has TEXT: What EXACTLY is the text? (read it word by word)
- If it has NO TEXT: You MUST ensure ALL variations are also text-free (no job titles, no labels, nothing!)
- What is the main subject/symbol in the image? (state name, animal, object, etc.)
- What is the visual style? (cartoon, realistic, vintage, minimalist, etc.)
- What colors dominate?
- What is the overall mood? (funny, emotional, motivational, celebratory, etc.)
- If text exists, how many words are in it? Count them!

**STEP 2: UNDERSTAND WHY IT SELLS**
Ask yourself as a market expert:
- WHO is the target customer? (age, interests, lifestyle, values)
- WHAT emotional need does this fulfill? (pride, love, humor, identity, belonging)
- WHY would someone pay money for THIS specific design?
- WHAT makes it special or relatable?
- Is there a SECRET to its appeal? (nostalgia, inside joke, community pride, personal milestone)

**STEP 3: IDENTIFY THE CORE SELLING POINT**
What is the ONE thing that makes people buy this?
- Is it about IDENTITY? (profession, hobby, personality trait)
- Is it about RELATIONSHIPS? (family, friends, pets)
- Is it about ACHIEVEMENTS? (milestones, age, success)
- Is it about PASSION? (sports, food, activities)
- Is it about HUMOR? (sarcasm, wordplay, relatable situations)

**STEP 4: DISCOVER THE VARIABLES (CRITICAL!)**
Now analyze what CAN change while keeping the same selling power:
- Look at the ACTUAL design image - what is the main subject/symbol?
- Look at the ACTUAL text - which words identify the niche?
- How many VARIABLES exist? (1, 2, 3, or more?)
- What are they SPECIFICALLY in THIS design? (not general examples!)
- Which variables are SAFE to change? (won't break the design's appeal)
- Which variables are DANGEROUS to change? (will ruin the meaning)
IMPORTANT: Don't use generic examples! Analyze THIS specific design!

**STEP 5: IDENTIFY THE CONSTANTS**
What MUST stay identical for the design to remain strong?
- Sentence structure and word count
- Emotional tone and message
- Visual style and layout
- The relationship between elements
- The "formula" that makes it work

**STEP 6: FIND HIGH-DEMAND NICHES**
Based on market statistics and customer behavior:
- What OTHER audiences have the SAME emotional needs?
- What OTHER subjects create the SAME level of passion?
- What OTHER niches have PROVEN buying power?
- Which variations will have the LARGEST potential market?
- Which variations target UNDERSERVED but profitable niches?

**STEP 7: PREDICT SUCCESS RATE**
For each potential variation idea:
- Will this variation sell as well as the original? (market demand)
- Is there statistical evidence this niche buys t-shirts?
- Does this variation tap into the SAME emotional trigger?
- Will the target audience instantly "get it" and feel connected?
---
ðŸŽ¯ PHASE 2: CREATING WINNING VARIATIONS
Now that you understand WHY the design sells, create variations that will ALSO sell:

**GOLDEN RULES:**
1. **PRESERVE THE FORMULA** - Keep what makes it work (structure, emotion, style)
2. **CHANGE ONLY VARIABLES** - Swap subjects/words that target different niches
3. **MAINTAIN QUALITY** - Each variation must be as strong as the original
4. **TARGET REAL MARKETS** - Choose niches with proven buying power
5. **LOGICAL CONSISTENCY** - Every element must make sense together

**TEXT HANDLING (CRITICAL!):**
- FIRST: Read the ACTUAL text in the design image carefully!
- Count EXACTLY how many words are in the original text
- If original HAS text â†’ ALL variations MUST have text (SAME word count, perfect spelling, NO repetition)
- ðŸš¨ IF ORIGINAL HAS NO TEXT â†’ ALL VARIATIONS MUST BE COMPLETELY TEXT-FREE ðŸš¨
  * ABSOLUTELY NO text, words, letters, or typography of ANY kind
  * Do NOT add job titles, names, labels, captions, or ANY written text
  * The design must be 100% visual/graphic only - like the original
  * If you add ANY text when original has none â†’ YOU FAILED
- Each word appears ONLY ONCE (no repetition!)
- Keep same grammar structure (verbâ†’verb, nounâ†’noun)
- IMPORTANT: Don't assume text from examples - READ the actual design!

**VISUAL CONSISTENCY:**
- Keep EXACT same art style (cartoonâ†’cartoon, realisticâ†’realistic)
- Keep EXACT same colors and layout
- Keep EXACT same mood and tone
- Background MUST be ${CONSTANTS.GRAY_BACKGROUND}
- Only change the subject/variable elements

**MARKET VALIDATION:**
Before finalizing each variation, ask:
- Would someone actually buy this?
- Is this niche large enough?
- Does this make logical sense?
- Will the target audience relate to it?
If answer is NO to any â†’ REJECT and try a better variation!
---
ðŸ“¤ OUTPUT FORMAT (STRICT - NO EXCEPTIONS!):
You MUST return ONLY a valid JSON array. Nothing else. No explanations, no markdown, no comments.

**MANDATORY JSON STRUCTURE:**
Your response must be EXACTLY in this format:
[
  "description 1",
  "description 2",
  "description 3"
]

**STRICT JSON RULES:**
1. Start with [ and end with ]
2. Each item is a STRING in double quotes: "text here"
3. Separate items with commas
4. NO single quotes ('), ONLY double quotes (")
5. NO special characters like â€¢ âœ“ â†’ âžœ etc.
6. NO line breaks inside strings
7. NO trailing comma after last item
8. Use only plain ASCII text

**EXACT FORMAT YOU MUST FOLLOW:**
ðŸš¨ **IF ORIGINAL HAS TEXT:**
Each description must be a COMPLETE READY-TO-USE PROMPT that includes:
1. Visual description of the subject
2. Art style and color instructions
3. EXACT text to be used (same word count as original)
4. Text styling instructions
5. Technical requirements (background, flat design, etc.)
Format: "You are an expert POD (Print-on-Demand) design AI. Create designs optimized for printing on products like t-shirts, mugs, and stickers. Ensure high contrast, vibrant colors, clean edges, and commercial-ready quality. A [subject] in the same art style and colors as the reference image, [details]. Use EXACT same visual style, colors, rendering technique, and composition from reference. Include text '[EXACT TEXT - SAME WORD COUNT AS ORIGINAL]' in the same font style and text layout as the original. CRITICAL: Create ONLY flat design graphic (NO mockup, NO product). Background must be solid ${CONSTANTS.GRAY_BACKGROUND}. Use ONLY the specified text above, ignore any text in reference image. Do NOT repeat words. ENLARGE the design to create a bold, prominent visual impact with enhanced clarity and detail - make it LARGE and fill 70-90% of the canvas area."

ðŸš¨ **IF ORIGINAL HAS NO TEXT:**
Format: "You are an expert POD (Print-on-Demand) design AI. Create designs optimized for printing on products like t-shirts, mugs, and stickers. Ensure high contrast, vibrant colors, clean edges, and commercial-ready quality. A [subject] in the same art style and colors as the reference image, [details]. Use EXACT same visual style, colors, rendering technique, and composition from reference. CRITICAL: Create ONLY flat design graphic (NO mockup, NO product). Background must be solid ${CONSTANTS.GRAY_BACKGROUND}. ABSOLUTELY NO TEXT - this is a text-free graphic design only. Do NOT add any words, letters, job titles, names, labels, or typography of ANY kind. ENLARGE the design to create a bold, prominent visual impact with enhanced clarity and detail - make it LARGE and fill 70-90% of the canvas area."`;
        };
        
        const EDIT_DESIGN_SYSTEM_PROMPT = (userEditPrompt) => `You are an expert POD design AI. Modify this design: ${userEditPrompt}. Keep the same art style, colors, and overall composition but apply the changes. Background must remain ${CONSTANTS.GRAY_BACKGROUND}. Ensure high contrast and commercial-ready quality. Temperature: 0.4`;

        // ================================================================
        // UTILITY FUNCTIONS
        // ================================================================

        /**
         * Generates a unique ID.
         * @returns {string} A unique identifier.
         */
        const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;

        /**
         * Reads a file as a Base64 Data URL.
         * @param {File} file - The file to read.
         * @returns {Promise<string>} A promise resolving with the base64 string.
         */
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
            });
        };

        /**
         * Formats file size.
         * @param {number} bytes - Size in bytes.
         * @returns {string} Formatted size (KB, MB).
         */
        const formatBytes = (bytes, decimals = 2) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        };

        /**
         * Formats a timestamp into a relative time string.
         * @param {number} timestamp - The timestamp (Date.now()).
         * @returns {string} Relative time (e.g., "5 mins ago").
         */
        const timeAgo = (timestamp) => {
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " mins ago";
            return "Just now";
        };
        
        /**
         * Creates a debounced version of a function.
         * @param {Function} func - The function to debounce.
         * @param {number} delay - The delay in milliseconds.
         */
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        /**
         * Downloads a base64 image as a file.
         * @param {string} base64Data - The base64 string of the image.
         * @param {string} filename - The desired filename.
         */
        const downloadBase64Image = (base64Data, filename) => {
            const link = document.createElement('a');
            link.href = base64Data;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // ================================================================
        // MODAL & UI MANAGEMENT
        // ================================================================

        /**
         * Displays a toast notification.
         * @param {string} message - The message to display.
         * @param {'success' | 'error' | 'warning'} type - The type of toast.
         * @param {number} [duration=5000] - Duration in ms.
         */
        const showToast = (message, type, duration = 5000) => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'â„¹ï¸'; // Default
            if (type === 'success') icon = 'âœ“';
            if (type === 'error') icon = 'âœ—';
            if (type === 'warning') icon = 'âš ';

            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <p>${message}</p>
            `;

            DOMElements.toastContainer.appendChild(toast);

            // Animate in (handled by CSS)

            // Auto-dismiss
            setTimeout(() => {
                // Animate out
                toast.style.animation = 'slideOut 0.3s ease-in forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, duration);
        };

        /**
         * Opens a modal.
         * @param {HTMLElement} modalElement - The modal element to open.
         */
        const openModal = (modalElement) => {
            modalElement.classList.add('active');
            appState.activeModal = modalElement;
            DOMElements.app.setAttribute('aria-hidden', 'true');
        };

        /**
         * Closes the currently active modal.
         */
        const closeModal = () => {
            if (appState.activeModal) {
                appState.activeModal.classList.remove('active');
                DOMElements.app.removeAttribute('aria-hidden');
                appState.activeModal = null;
            }
        };

        /**
         * Initializes all modal open/close listeners.
         */
        const initModalListeners = () => {
            DOMElements.apiSettingsBtn.addEventListener('click', () => {
                DOMElements.apiKeyInput.value = appState.apiKey || '';
                DOMElements.apiTestResult.textContent = '';
                openModal(DOMElements.apiSettingsModal);
            });

            // Add listeners for all close buttons
            $$('[data-dismiss="modal"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    closeModal();
                });
            });

            // Close modal on outside click
            $$('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            });

            // Close on Escape key
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && appState.activeModal) {
                    closeModal();
                }
            });
        };

        /**
         * Toggles between 'normal' and 'variations' modes.
         * @param {'normal' | 'variations'} mode - The mode to switch to.
         */
        const switchMode = (mode) => {
            if (mode === appState.currentMode) return;
            appState.currentMode = mode;

            DOMElements.modeToggleButtons.forEach(btn => {
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            if (mode === 'normal') {
                DOMElements.modeNormal.classList.add('active');
                DOMElements.modeVariations.classList.remove('active');
            } else {
                DOMElements.modeNormal.classList.remove('active');
                DOMElements.modeVariations.classList.add('active');
            }
        };

        /**
         * Updates the character counter for a textarea.
         * @param {HTMLTextAreaElement} textarea - The textarea element.
         * @param {HTMLElement} counterElement - The counter display element.
         */
        const updateCharCounter = (textarea, counterElement) => {
            const count = textarea.value.length;
            const max = 500;
            counterElement.textContent = `${count}/${max}`;
            counterElement.classList.remove('warning', 'error');
            if (count > max) {
                counterElement.classList.add('error');
            } else if (count > max * 0.8) {
                counterElement.classList.add('warning');
            }
        };
        
        /**
         * Toggles the theme between light and dark.
         * @param {boolean} [forceDark] - Optional: force a specific mode.
         */
        const toggleTheme = (forceDark = null) => {
            const isDark = forceDark !== null ? forceDark : !document.documentElement.classList.contains('dark');
            document.documentElement.classList.toggle('dark', isDark);
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        };

        /**
         * Shows or hides the loading overlay.
         * @param {boolean} show - Whether to show the overlay.
         * @param {string} [progressText] - Text for progress (e.g., "1/10").
         * @param {string} [statusText] - Text for status (e.g., "Analyzing...").
         */
        const setLoading = (show, progressText = '', statusText = '') => {
            if (show) {
                DOMElements.loadingProgress.textContent = progressText;
                DOMElements.loadingStatus.textContent = statusText;
                DOMElements.loadingOverlay.classList.add('active');
            } else {
                DOMElements.loadingOverlay.classList.remove('active');
            }
        };

        // ================================================================
        // CRYPTOGRAPHY (AES-GCM for API Key)
        // ================================================================

        const cryptoUtils = {
            /**
             * Derives an encryption key from user-specific data using PBKDF2.
             * @returns {Promise<CryptoKey>} The derived CryptoKey.
             */
            async getEncryptionKey() {
                try {
                    const material = await crypto.subtle.importKey(
                        'raw',
                        new TextEncoder().encode(navigator.userAgent.substring(0, 100) + window.location.hostname),
                        'PBKDF2',
                        false,
                        ['deriveKey']
                    );

                    return await crypto.subtle.deriveKey(
                        {
                            name: 'PBKDF2',
                            salt: new TextEncoder().encode(CONSTANTS.API_KEY_SALT),
                            iterations: 100000,
                            hash: 'SHA-256',
                        },
                        material,
                        { name: 'AES-GCM', length: 256 },
                        true,
                        ['encrypt', 'decrypt']
                    );
                } catch (error) {
                    console.error('Error deriving key:', error);
                    showToast('Could not set up encryption. Your browser might be in private mode.', 'error');
                    throw new Error('Key derivation failed');
                }
            },

            /**
             * Encrypts the API key.
             * @param {string} apiKey - The plaintext API key.
             * @returns {Promise<{encrypted: string, iv: string}>} Encrypted data and IV, base64-encoded.
             */
            async encryptAPIKey(apiKey) {
                appState.isEncrypting = true;
                try {
                    const key = await this.getEncryptionKey();
                    const iv = crypto.getRandomValues(new Uint8Array(12)); // 12 bytes is recommended for GCM
                    const encodedKey = new TextEncoder().encode(apiKey);

                    const encryptedData = await crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv },
                        key,
                        encodedKey
                    );

                    // Convert ArrayBuffer to Base64 string
                    const encryptedBase64 = btoa(String.fromCharCode.apply(null, new Uint8Array(encryptedData)));
                    const ivBase64 = btoa(String.fromCharCode.apply(null, iv));

                    return { encrypted: encryptedBase64, iv: ivBase64 };
                } catch (error) {
                    console.error('Encryption failed:', error);
                    showToast('Failed to encrypt API key.', 'error');
                } finally {
                    appState.isEncrypting = false;
                }
            },

            /**
             * Decrypts the API key.
             * @param {string} encryptedBase64 - The encrypted, base64-encoded API key.
             * @param {string} ivBase64 - The base64-encoded IV.
             * @returns {Promise<string|null>} The decrypted API key or null on failure.
             */
            async decryptAPIKey(encryptedBase64, ivBase64) {
                if (!encryptedBase64 || !ivBase64) return null;

                try {
                    const key = await this.getEncryptionKey();

                    // Convert Base64 back to ArrayBuffer
                    const encryptedData = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
                    const iv = Uint8Array.from(atob(ivBase64), c => c.charCodeAt(0));

                    const decryptedData = await crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv },
                        key,
                        encryptedData
                    );

                    return new TextDecoder().decode(decryptedData);
                } catch (error) {
                    console.error('Decryption failed:', error);
                    // This can fail if the user agent changes (e.g., browser update)
                    showToast('Failed to decrypt API key. Please re-enter it.', 'warning');
                    await dbUtils.clearAPIKey(); // Clear the bad key
                    return null;
                }
            }
        };

        // ================================================================
        // INDEXEDDB DATABASE UTILITIES
        // ================================================================

        const dbUtils = {
            /**
             * Initializes the IndexedDB database.
             * @returns {Promise<IDBDatabase>} The database instance.
             */
            initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(CONSTANTS.DB_NAME, CONSTANTS.DB_VERSION);

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        // Object Store 1: api_keys
                        if (!db.objectStoreNames.contains('api_keys')) {
                            db.createObjectStore('api_keys', { keyPath: 'id' });
                        }
                        // Object Store 2: designs
                        if (!db.objectStoreNames.contains('designs')) {
                            const designStore = db.createObjectStore('designs', { keyPath: 'id' });
                            designStore.createIndex('createdAt', 'createdAt', { unique: false });
                        }
                    };

                    request.onsuccess = (event) => {
                        appState.db = event.target.result;
                        resolve(appState.db);
                    };

                    request.onerror = (event) => {
                        console.error('IndexedDB error:', event.target.errorCode);
                        reject(event.target.errorCode);
                    };
                });
            },

            /**
             * Saves the encrypted API key to the DB.
             * @param {string} encrypted - Base64 encrypted key.
             * @param {string} iv - Base64 IV.
             */
            saveAPIKey(encrypted, iv) {
                return new Promise((resolve, reject) => {
                    if (!appState.db) return reject('DB not initialized');
                    const transaction = appState.db.transaction(['api_keys'], 'readwrite');
                    const store = transaction.objectStore('api_keys');
                    const data = {
                        id: CONSTANTS.API_KEY_ID,
                        encrypted,
                        iv,
                        created_at: Date.now()
                    };
                    const request = store.put(data);
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            },

            /**
             * Loads the encrypted API key from the DB.
             * @returns {Promise<{encrypted: string, iv: string}|null>}
             */
            loadAPIKey() {
                return new Promise((resolve, reject) => {
                    if (!appState.db) return reject('DB not initialized');
                    const transaction = appState.db.transaction(['api_keys'], 'readonly');
                    const store = transaction.objectStore('api_keys');
                    const request = store.get(CONSTANTS.API_KEY_ID);
                    request.onsuccess = (e) => {
                        resolve(e.target.result || null);
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            },
            
            /**
             * Clears the API key from the DB.
             */
            clearAPIKey() {
                return new Promise((resolve, reject) => {
                    if (!appState.db) return reject('DB not initialized');
                    const transaction = appState.db.transaction(['api_keys'], 'readwrite');
                    const store = transaction.objectStore('api_keys');
                    const request = store.delete(CONSTANTS.API_KEY_ID);
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            },

            /**
             * Saves a generated design to the DB.
             * @param {object} design - The design object to save.
             */
            saveDesign(design) {
                return new Promise((resolve, reject) => {
                    if (!appState.db) return reject('DB not initialized');
                    const transaction = appState.db.transaction(['designs'], 'readwrite');
                    const store = transaction.objectStore('designs');
                    const request = store.put(design);
                    request.onsuccess = () => resolve(design);
                    request.onerror = (e) => reject(e.target.error);
                });
            },

            /**
             * Loads all designs from the DB, sorted by creation date.
             * @returns {Promise<Array<object>>}
             */
            loadAllDesigns() {
                return new Promise((resolve, reject) => {
                    if (!appState.db) return reject('DB not initialized');
                    const transaction = appState.db.transaction(['designs'], 'readonly');
                    const store = transaction.objectStore('designs');
                    const index = store.index('createdAt');
                    const request = index.getAll(); // Get all
                    
                    request.onsuccess = (e) => {
                        // Sort descending (newest first)
                        const sorted = e.target.result.sort((a, b) => b.createdAt - a.createdAt);
                        resolve(sorted);
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            },
            
            /**
             * Deletes a design from the DB.
             * @param {string} id - The ID of the design to delete.
             */
            deleteDesign(id) {
                return new Promise((resolve, reject) => {
                    if (!appState.db) return reject('DB not initialized');
                    const transaction = appState.db.transaction(['designs'], 'readwrite');
                    const store = transaction.objectStore('designs');
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            }
        };

        // ================================================================
        // API KEY MANAGEMENT
        // ================================================================

        /**
         * Handles saving the API key from the modal.
         */
        const handleSaveAPIKey = async () => {
            const apiKey = DOMElements.apiKeyInput.value.trim();
            if (!apiKey) {
                showToast('API Key cannot be empty', 'error');
                return;
            }
            if (!apiKey.startsWith('AI')) {
                showToast('Invalid API Key format. It should start with "AI".', 'warning');
            }

            try {
                const { encrypted, iv } = await cryptoUtils.encryptAPIKey(apiKey);
                await dbUtils.saveAPIKey(encrypted, iv);
                appState.apiKey = apiKey;
                DOMElements.apiStatusIndicator.classList.add('configured');
                showToast('API Key saved successfully!', 'success');
                closeModal();
                updateGenerationButtons();
            } catch (error) {
                console.error('Error saving API key:', error);
                showToast('Could not save API key.', 'error');
            }
        };
        
        /**
         * Clears the saved API key.
         */
        const handleClearAPIKey = async () => {
            try {
                await dbUtils.clearAPIKey();
                appState.apiKey = null;
                DOMElements.apiKeyInput.value = '';
                DOMElements.apiStatusIndicator.classList.remove('configured');
                DOMElements.apiTestResult.textContent = 'API Key cleared.';
                DOMElements.apiTestResult.className = 'api-test-result';
                showToast('API Key cleared.', 'success');
                updateGenerationButtons();
            } catch (error) {
                console.error('Error clearing API key:', error);
                showToast('Could not clear API key.', 'error');
            }
        };

        /**
         * Loads and decrypts the API key on app start.
         */
        const loadAndDecryptApiKey = async () => {
            try {
                const data = await dbUtils.loadAPIKey();
                if (data && !appState.isEncrypting) {
                    const decryptedKey = await cryptoUtils.decryptAPIKey(data.encrypted, data.iv);
                    if (decryptedKey) {
                        appState.apiKey = decryptedKey;
                        DOMElements.apiStatusIndicator.classList.add('configured');
                        showToast('API Key loaded.', 'success');
                    } else {
                        DOMElements.apiStatusIndicator.classList.remove('configured');
                    }
                }
            } catch (error) {
                console.error('Error loading API key:', error);
            }
            updateGenerationButtons();
        };

        /**
         * Tests the provided API key by making a simple request.
         */
        const handleTestAPIKey = async () => {
            const apiKey = DOMElements.apiKeyInput.value.trim();
            if (!apiKey) {
                DOMElements.apiTestResult.textContent = 'Please enter an API key.';
                DOMElements.apiTestResult.className = 'api-test-result error';
                return;
            }

            DOMElements.apiTestResult.textContent = 'Testing...';
            DOMElements.apiTestResult.className = 'api-test-result';

            try {
                // Use dynamic URL function
                const testUrl = `${getApiUrlText()}?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: "Hello" }] }]
                };
                
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    DOMElements.apiTestResult.textContent = 'âœ“ API Key is valid!';
                    DOMElements.apiTestResult.className = 'api-test-result success';
                } else {
                    const error = await response.json();
                    throw new Error(error.error.message || `Status: ${response.status}`);
                }
            } catch (error) {
                console.error('API Key test failed:', error);
                DOMElements.apiTestResult.textContent = `Test failed: ${error.message}`;
                DOMElements.apiTestResult.className = 'api-test-result error';
            }
        };

        // ================================================================
        // FILE HANDLING & THUMBNAILS
        // ================================================================

        /**
         * Handles file uploads (from drop or input).
         * @param {FileList} files - The list of files.
         * @param {'style' | 'niche' | 'variation'} type - The type of upload.
         */
        const handleFileUpload = async (files, type) => {
            const fileList = Array.from(files);
            let targetArray, maxFiles, gridElement, infoElement;
            let isSingleFile = false;

            if (type === 'style') {
                targetArray = appState.styleFiles;
                maxFiles = CONSTANTS.MAX_FILES;
                gridElement = DOMElements.styleThumbnailGrid;
                infoElement = DOMElements.styleUploadInfo;
            } else if (type === 'niche') {
                targetArray = appState.nicheFiles;
                maxFiles = CONSTANTS.MAX_FILES;
                gridElement = DOMElements.nicheThumbnailGrid;
                infoElement = DOMElements.nicheUploadInfo;
            } else { // variation
                targetArray = []; // Reset for single file
                appState.variationFile = null;
                maxFiles = 1;
                gridElement = DOMElements.variationThumbnailGrid;
                infoElement = DOMElements.variationUploadInfo;
                isSingleFile = true;
            }

            if (!isSingleFile && targetArray.length + fileList.length > maxFiles) {
                showToast(`You can only upload a maximum of ${maxFiles} files.`, 'error');
                fileList.splice(maxFiles - targetArray.length); // Truncate
            }
            
            if (isSingleFile && fileList.length > 1) {
                showToast('Please upload only one file for variations.', 'error');
                fileList.splice(1); // Take only the first
            }
            
            if (isSingleFile) gridElement.innerHTML = ''; // Clear for single file

            for (const file of fileList) {
                if (!file.type.startsWith('image/')) {
                    showToast(`File ${file.name} is not an image.`, 'warning');
                    continue;
                }
                
                const id = generateId();
                const base64 = await fileToBase64(file);
                const fileObject = { id, file, base64, selected: false };
                
                if (isSingleFile) {
                    appState.variationFile = fileObject;
                } else {
                    targetArray.push(fileObject);
                }
                
                renderThumbnail(fileObject, gridElement, type, isSingleFile ? 1 : targetArray.length);
            }
            
            updateUploadInfo(type);
        };

        /**
         * Renders a file thumbnail in the specified grid.
         * @param {object} fileObject - The file object { id, base64 }.
         * @param {HTMLElement} gridElement - The grid to append to.
         * @param {'style' | 'niche' | 'variation'} type - The type of upload.
         * @param {number} index - The display index.
         */
        const renderThumbnail = (fileObject, gridElement, type, index) => {
            const thumb = document.createElement('div');
            thumb.className = 'thumbnail';
            thumb.dataset.id = fileObject.id;
            thumb.dataset.type = type;
            thumb.title = fileObject.file.name;
            thumb.style.animationDelay = `${(index % 20) * 50}ms`; // Stagger animation

            thumb.innerHTML = `
                <img src="${fileObject.base64}" alt="${fileObject.file.name}">
                <span class="thumbnail-index">${index}</span>
                <button class="thumbnail-remove" data-id="${fileObject.id}" data-type="${type}">&times;</button>
            `;
            
            gridElement.appendChild(thumb);
            
            // Add click listener for selection
            if (type !== 'variation') {
                thumb.addEventListener('click', (e) => {
                    if (e.target.classList.contains('thumbnail-remove')) return;
                    toggleThumbnailSelection(thumb, fileObject);
                });
            }
        };
        
        /**
         * Toggles the 'selected' state of a thumbnail.
         * @param {HTMLElement} thumbElement - The thumbnail DOM element.
         * @param {object} fileObject - The file object in state.
         */
        const toggleThumbnailSelection = (thumbElement, fileObject) => {
            fileObject.selected = !fileObject.selected;
            thumbElement.style.outline = fileObject.selected ? '3px solid #667eea' : 'none';
        };

        /**
         * Handles thumbnail grid-related actions (remove, select all, delete).
         */
        const initThumbnailGridActions = () => {
            DOMElements.app.addEventListener('click', (e) => {
                const target = e.target;
                
                // Remove button on thumbnail
                if (target.classList.contains('thumbnail-remove')) {
                    e.stopPropagation();
                    const id = target.dataset.id;
                    const type = target.dataset.type;
                    removeFile(id, type);
                }
                
                // Bulk actions
                if (target.dataset.action === 'select-all') {
                    const type = target.dataset.target;
                    const { fileArray, grid } = getFileArrayAndGrid(type);
                    const allSelected = fileArray.every(f => f.selected);
                    
                    fileArray.forEach(f => f.selected = !allSelected);
                    grid.querySelectorAll('.thumbnail').forEach((thumb, i) => {
                        thumb.style.outline = fileArray[i].selected ? '3px solid #667eea' : 'none';
                    });
                    
                    target.textContent = allSelected ? 'Select All' : 'Deselect All';
                }
                
                if (target.dataset.action === 'delete-selected') {
                    const type = target.dataset.target;
                    const { fileArray, grid } = getFileArrayAndGrid(type);
                    const selectedIds = fileArray.filter(f => f.selected).map(f => f.id);
                    
                    if (selectedIds.length === 0) {
                        showToast('No images selected to delete.', 'warning');
                        return;
                    }
                    
                    selectedIds.forEach(id => removeFile(id, type, false)); // Don't re-render info yet
                    updateUploadInfo(type); // Re-render info once
                }
            });
        };
        
        /**
         * Helper to get the correct file array and grid element by type.
         */
        const getFileArrayAndGrid = (type) => {
            if (type === 'style') {
                return { fileArray: appState.styleFiles, grid: DOMElements.styleThumbnailGrid };
            } else if (type === 'niche') {
                return { fileArray: appState.nicheFiles, grid: DOMElements.nicheThumbnailGrid };
            }
            return { fileArray: [], grid: null }; // Should not happen for bulk
        };

        /**
         * Removes a file from state and UI.
         * @param {string} id - The ID of the file to remove.
         * @param {'style' | 'niche' | 'variation'} type - The type of upload.
         * @param {boolean} [updateInfo=true] - Whether to update info (for bulk delete).
         */
        const removeFile = (id, type, updateInfo = true) => {
            let targetArray;
            let gridElement;

            if (type === 'style') {
                targetArray = appState.styleFiles;
                gridElement = DOMElements.styleThumbnailGrid;
            } else if (type === 'niche') {
                targetArray = appState.nicheFiles;
                gridElement = DOMElements.nicheThumbnailGrid;
            } else { // variation
                appState.variationFile = null;
                gridElement = DOMElements.variationThumbnailGrid;
                gridElement.innerHTML = ''; // Just clear the grid
                if (updateInfo) updateUploadInfo(type);
                return;
            }

            const index = targetArray.findIndex(f => f.id === id);
            if (index > -1) {
                targetArray.splice(index, 1);
                const thumb = gridElement.querySelector(`[data-id="${id}"]`);
                if (thumb) thumb.remove();
                if (updateInfo) updateUploadInfo(type);
            }
        };

        /**
         * Updates the "X/50 images" info text.
         * @param {'style' | 'niche' | 'variation'} type - The type of upload.
         */
        const updateUploadInfo = (type) => {
            let count, infoElement, totalSize, fileArray;
            
            if (type === 'style') {
                fileArray = appState.styleFiles;
                infoElement = DOMElements.styleUploadInfo;
            } else if (type === 'niche') {
                fileArray = appState.nicheFiles;
                infoElement = DOMElements.nicheUploadInfo;
            } else { // variation
                count = appState.variationFile ? 1 : 0;
                infoElement = DOMElements.variationUploadInfo;
                infoElement.textContent = count === 1 ? `1 image uploaded` : 'No image uploaded';
                updateGenerationButtons(); // Update button state
                return;
            }

            count = fileArray.length;
            totalSize = fileArray.reduce((acc, f) => acc + f.file.size, 0);
            infoElement.textContent = `${count}/${CONSTANTS.MAX_FILES} images | ${formatBytes(totalSize)}`;
            
            // Re-index thumbnails
            let gridElement = (type === 'style') ? DOMElements.styleThumbnailGrid : DOMElements.nicheThumbnailGrid;
            gridElement.querySelectorAll('.thumbnail-index').forEach((span, i) => {
                span.textContent = i + 1;
            });
            
            updateGenerationButtons(); // Update button state
        };

        /**
         * Initializes all drag-and-drop listeners.
         */
        const initDragAndDrop = () => {
            const zones = [
                { zone: DOMElements.styleDropZone, input: DOMElements.styleFileInput, type: 'style' },
                { zone: DOMElements.nicheDropZone, input: DOMElements.nicheFileInput, type: 'niche' },
                { zone: DOMElements.variationDropZone, input: DOMElements.variationFileInput, type: 'variation' }
            ];

            zones.forEach(({ zone, input, type }) => {
                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    zone.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    }, false);
                });

                // Highlight on drag
                ['dragenter', 'dragover'].forEach(eventName => {
                    zone.addEventListener(eventName, () => zone.classList.add('drag-over'), false);
                });
                ['dragleave', 'drop'].forEach(eventName => {
                    zone.addEventListener(eventName, () => zone.classList.remove('drag-over'), false);
                });

                // Handle drop
                zone.addEventListener('drop', (e) => {
                    handleFileUpload(e.dataTransfer.files, type);
                }, false);

                // Handle click to browse
                zone.addEventListener('click', () => {
                    input.click();
                });

                // Handle file input change
                input.addEventListener('change', (e) => {
                    handleFileUpload(e.target.files, type);
                    e.target.value = null; // Reset for same-file upload
                });
            });
        };

        // ================================================================
        // IMAGE PREPROCESSING (THE COMPLEX PART)
        // ================================================================

        /**
         * Preprocesses an uploaded image:
         * 1. Finds content boundaries (auto-crop)
         * 2. Creates a new canvas
         * 3. Fills with #808080 gray
         * 4. Draws cropped content onto the new canvas
         * 5. Returns base64 PNG
         * @param {File} file - Image file to preprocess.
         * @returns {Promise<string>} Base64 encoded preprocessed image.
         */
        async function preprocessImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();

                reader.onload = (e) => {
                    img.src = e.target.result;
                };
                reader.onerror = reject;

                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d', { willReadFrequently: true });
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        // --- Start: Smart Crop Logic ---
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;

                        // 1. Sample background color (from corners)
                        // (r, g, b, a)
                        const corners = [
                            getPixel(0, 0),                                // Top-left
                            getPixel(canvas.width - 1, 0),                 // Top-right
                            getPixel(0, canvas.height - 1),                // Bottom-left
                            getPixel(canvas.width - 1, canvas.height - 1)  // Bottom-right
                        ];

                        // Average the corner colors
                        const avgBg = corners.reduce((acc, c) => {
                            return { r: acc.r + c.r, g: acc.g + c.g, b: acc.b + c.b, a: acc.a + c.a };
                        }, { r: 0, g: 0, b: 0, a: 0 });
                        
                        avgBg.r /= corners.length;
                        avgBg.g /= corners.length;
                        avgBg.b /= corners.length;
                        avgBg.a /= corners.length;

                        let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;
                        const tolerance = 30; // Color difference tolerance

                        // 2. Scan pixels for content boundaries
                        for (let y = 0; y < canvas.height; y++) {
                            for (let x = 0; x < canvas.width; x++) {
                                const { r, g, b, a } = getPixel(x, y);

                                // Is pixel "content"?
                                // Condition: Alpha > 10 AND color is different from BG
                                const isTransparent = a < 10;
                                const colorDiff = Math.abs(r - avgBg.r) + Math.abs(g - avgBg.g) + Math.abs(b - avgBg.b);
                                const isBgColor = colorDiff < tolerance && (a - avgBg.a < tolerance);

                                if (!isTransparent && !isBgColor) {
                                    if (x < minX) minX = x;
                                    if (x > maxX) maxX = x;
                                    if (y < minY) minY = y;
                                    if (y > maxY) maxY = y;
                                }
                            }
                        }
                        
                        // Helper to get pixel data
                        function getPixel(x, y) {
                            const i = (y * canvas.width + x) * 4;
                            return { r: data[i], g: data[i+1], b: data[i+2], a: data[i+3] };
                        }

                        // 3. Calculate crop rectangle with padding
                        let cropWidth, cropHeight, cropX, cropY;

                        if (maxX <= minX || maxY <= minY) {
                            // No content found (or solid color), use full image
                            minX = 0; minY = 0;
                            cropWidth = canvas.width;
                            cropHeight = canvas.height;
                        } else {
                            const padding = Math.min(Math.max(canvas.width * 0.05, canvas.height * 0.05), 20); // 5% padding, max 20px
                            cropX = Math.max(0, minX - padding);
                            cropY = Math.max(0, minY - padding);
                            const newMaxX = Math.min(canvas.width, maxX + padding);
                            const newMaxY = Math.min(canvas.height, maxY + padding);
                            
                            cropWidth = newMaxX - cropX;
                            cropHeight = newMaxY - cropY;
                        }
                        
                        // --- End: Smart Crop Logic ---

                        // 4. Create new canvas with #808080 background
                        const newCanvas = document.createElement('canvas');
                        // Make canvas square, based on largest dimension
                        const newSize = Math.max(cropWidth, cropHeight);
                        newCanvas.width = newSize;
                        newCanvas.height = newSize;
                        
                        const newCtx = newCanvas.getContext('2d');
                        
                        // Fill with solid #808080
                        newCtx.fillStyle = CONSTANTS.GRAY_BACKGROUND;
                        newCtx.fillRect(0, 0, newSize, newSize);

                        // 5. Draw cropped content centered on gray background
                        const destX = (newSize - cropWidth) / 2;
                        const destY = (newSize - cropHeight) / 2;
                        
                        newCtx.drawImage(
                            canvas,         // Source canvas
                            minX, minY,     // Source X, Y
                            cropWidth, cropHeight, // Source W, H
                            destX, destY,   // Dest X, Y
                            cropWidth, cropHeight  // Dest W, H
                        );

                        // 6. Export as PNG base64
                        resolve(newCanvas.toDataURL('image/png'));

                    } catch (error) {
                        console.error('Error in preprocessing canvas:', error);
                        // Fallback: just return original base64
                        resolve(img.src);
                    }
                };
                
                img.onerror = () => {
                    reject(new Error('Failed to load image for preprocessing.'));
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        /**
         * Strips the "data:image/..." prefix from a base64 string.
         * @param {string} base64String - The full data URL.
         * @returns {string} The raw base64 data.
         */
        const stripBase64Prefix = (base64String) => {
            return base64String.split(',')[1] || base64String;
        };

        // ================================================================
        // API COMMUNICATION (GEMINI)
        // ================================================================

        /**
         * Performs an API call with exponential backoff.
         * @param {string} url - The API endpoint.
         * @param {object} payload - The request payload.
         * @param {number} [maxRetries=3] - Maximum number of retries.
         * @returns {Promise<object>} The JSON response.
         */
        const fetchWithRetry = async (url, payload, maxRetries = 3) => {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    // If user has provided a key, use it.
                    // Otherwise, send no key parameter, which allows Canvas to use the default.
                    const fetchUrl = appState.apiKey
                        ? `${url}?key=${appState.apiKey}`
                        : url; // No key parameter

                    const response = await fetch(fetchUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    }

                    if (response.status === 429) { // Rate limit
                        attempt++;
                        const delay = Math.pow(2, attempt) * 1000; // 2s, 4s, 8s
                        console.warn(`Rate limit hit. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    }
                    
                    // Other errors
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `HTTP ${response.status}`);

                } catch (error) {
                    // This catches network errors, or errors thrown from non-OK responses
                    console.error('API call failed on attempt ' + (attempt + 1), error);

                    // If it's a non-retryable API error (like 400/500) we threw, just re-throw it.
                    if (error.message.startsWith('HTTP') || error.message.startsWith('Invalid response')) {
                        throw error;
                    }
                    
                    // It's a network error. Let's retry.
                    attempt++; // Increment attempt for network error
                    if (attempt >= maxRetries) {
                        // We've used up retries on network errors
                        throw new Error(`API call failed after ${maxRetries} attempts due to network errors.`);
                    }
                    
                    const delay = Math.pow(2, attempt) * 1000; // 2s, 4s, 8s
                    console.warn(`Network error. Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    // The loop will continue
                }
            }
            throw new Error(`API call failed after ${maxRetries} attempts, likely due to API rate-limiting. Please try again later or add your own API key.`);
        };
        
        /**
         * Calls the Gemini text model (gemini-2.5-flash-preview-09-2025).
         * @param {string} prompt - The text prompt.
         * @param {string[]} [base64Images=[]] - Array of full base64 data URLs.
         * @param {boolean} [isJson=false] - Whether to expect a JSON response.
         * @returns {Promise<string>} The generated text content.
         */
        const callGeminiText = async (prompt, base64Images = [], isJson = false) => {
            const parts = [{ text: prompt }];
            
            base64Images.forEach(b64 => {
                parts.push({
                    inlineData: {
                        mimeType: 'image/png',
                        data: stripBase64Prefix(b64)
                    }
                });
            });

            const payload = {
                contents: [{ role: "user", parts }],
                generationConfig: {}
            };
            
            if (isJson) {
                payload.generationConfig.responseMimeType = "application/json";
            }
            
            // Use dynamic URL function
            const result = await fetchWithRetry(getApiUrlText(), payload);
            
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) {
                throw new Error('Invalid response from AI (text).');
            }
            return text;
        };
        
        /**
         * Calls the Gemini image model (gemini-2.5-flash-image-preview).
         * @param {string} prompt - The text prompt.
         * @param {string[]} [base64Images=[]] - Array of full base64 data URLs.
         * @returns {Promise<string>} The generated image as a base64 data URL.
         */
        const callGeminiImage = async (prompt, base64Images = []) => {
            const parts = [{ text: prompt }];
            
            base64Images.forEach(b64 => {
                parts.push({
                    inlineData: {
                        mimeType: 'image/png',
                        data: stripBase64Prefix(b64)
                    }
                });
            });
            
            const payload = {
                contents: [{ role: "user", parts }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE']
                },
            };
            
            // Use dynamic URL function
            const result = await fetchWithRetry(getApiUrlImage(), payload);

            const imagePart = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData && p.inlineData.mimeType.startsWith('image/'));
            
            if (!imagePart) {
                const textPart = result.candidates?.[0]?.content?.parts?.[0]?.text;
                console.error('AI Response (Text):', textPart);
                throw new Error(textPart || 'Invalid response from AI (image).');
            }
            
            return `data:${imagePart.inlineData.mimeType};base64,${imagePart.inlineData.data}`;
        };

        // ================================================================
        // CORE GENERATION LOGIC
        // ================================================================

        /**
         * Updates the enable/disable state of generation buttons.
         */
        const updateGenerationButtons = () => {
            
            // Normal Mode
            const hasStyles = appState.styleFiles.length > 0;
            const hasNiches = appState.nicheFiles.length > 0;
            const canGenNormal = hasStyles && hasNiches; // Removed 'hasApiKey' check
            DOMElements.normalGenBtn.disabled = !canGenNormal;
            if (canGenNormal) {
                DOMElements.normalGenBtn.classList.add('pulsing');
            } else {
                DOMElements.normalGenBtn.classList.remove('pulsing');
            }
            const normalCount = appState.styleFiles.length * appState.nicheFiles.length;
            DOMElements.normalGenStatus.innerHTML = `Ready to generate <strong>${normalCount} design${normalCount !== 1 ? 's' : ''}</strong>`;

            // Variations Mode
            const hasVariationFile = !!appState.variationFile;
            const canGenVariation = hasVariationFile; // Removed 'hasApiKey' check
            DOMElements.variationGenBtn.disabled = !canGenVariation;
            if (canGenVariation) {
                DOMElements.variationGenBtn.classList.add('pulsing');
            } else {
                DOMElements.variationGenBtn.classList.remove('pulsing');
            }
            const variationCount = parseInt(DOMElements.variationCountInput.value, 10) || 0;
            DOMElements.variationGenStatus.innerHTML = `Ready to generate <strong>${variationCount} variation${variationCount !== 1 ? 's' : ''}</strong>`;
        };
        
        /**
         * Cancels the currently running generation job.
         */
        const cancelGeneration = () => {
            if (appState.currentJobId) {
                appState.currentJobId = null; // Set flag to stop loops
                setLoading(false);
                showToast('Generation cancelled.', 'warning');
            }
        };

        /**
         * Main function to handle "Normal Mode" generation (Style Transfer).
         */
        const handleGenerateNormal = async () => {
            const jobId = generateId();
            appState.currentJobId = jobId;
            
            const styles = [...appState.styleFiles];
            const niches = [...appState.nicheFiles];
            const userPrompt = DOMElements.normalPrompt.value.trim();
            const totalJobs = styles.length * niches.length;
            
            if (totalJobs === 0) return;
            
            setLoading(true, `0 / ${totalJobs}`, 'Starting generation...');
            
            let completedJobs = 0;
            try {
                for (const styleFile of styles) {
                    for (const nicheFile of niches) {
                        if (appState.currentJobId !== jobId) break; // Check for cancellation
                        
                        const statusText = `Generating design ${completedJobs + 1} / ${totalJobs}`;
                        setLoading(true, `${completedJobs + 1} / ${totalJobs}`, statusText);
                        
                        // 1. Preprocess both images
                        if (!styleFile.preprocessedB64) {
                            setLoading(true, `${completedJobs + 1} / ${totalJobs}`, `${statusText} (Processing style...)`);
                            styleFile.preprocessedB64 = await preprocessImage(styleFile.file);
                        }
                        if (!nicheFile.preprocessedB64) {
                            setLoading(true, `${completedJobs + 1} / ${totalJobs}`, `${statusText} (Processing niche...)`);
                            nicheFile.preprocessedB64 = await preprocessImage(nicheFile.file);
                        }
                        
                        // 2. Create the style transfer prompt
                        const prompt = `You are an expert POD (Print-on-Demand) design AI. 
                        Your task is to perform a style transfer.
                        - The FIRST image defines the ART STYLE (colors, texture, rendering).
                        - The SECOND image defines the SUBJECT & COMPOSITION (the content).
                        Combine them to create a new design where the SUBJECT from image 2 is rendered in the ART STYLE of image 1.
                        ${userPrompt ? `User guidance: "${userPrompt}"` : ""}
                        CRITICAL: Create ONLY a flat design graphic. Background must be solid ${CONSTANTS.GRAY_BACKGROUND}.`;
                        
                        // 3. Call image generation API
                        setLoading(true, `${completedJobs + 1} / ${totalJobs}`, `${statusText} (AI Generating...)`);
                        const generatedImage = await callGeminiImage(prompt, [styleFile.preprocessedB64, nicheFile.preprocessedB64]);
                        
                        // 4. Save and render
                        const design = {
                            id: generateId(),
                            image: generatedImage,
                            niche: `Style: ${styleFile.file.name.substring(0, 15)}... Niche: ${nicheFile.file.name.substring(0, 15)}...`,
                            prompt: prompt,
                            mode: 'style_transfer',
                            favorite: false,
                            createdAt: Date.now()
                        };
                        
                        await dbUtils.saveDesign(design);
                        appState.generatedDesigns.unshift(design); // Add to start
                        renderResultCard(design, true); // Render with animation
                        
                        completedJobs++;
                    }
                    if (appState.currentJobId !== jobId) break;
                }
                
                if (appState.currentJobId === jobId) {
                    showToast(`Successfully generated ${completedJobs} designs!`, 'success');
                }
                
            } catch (error) {
                console.error('Error during Normal generation:', error);
                showToast(`Generation failed: ${error.message}`, 'error');
            } finally {
                setLoading(false);
                appState.currentJobId = null;
            }
        };
        
        /**
         * Main function to handle "Generate Variations" mode.
         */
        const handleGenerateVariations = async () => {
            const jobId = generateId();
            appState.currentJobId = jobId;
            
            const sourceFile = appState.variationFile;
            if (!sourceFile) return;
            
            const userPrompt = DOMElements.variationPrompt.value.trim();
            const variationCount = parseInt(DOMElements.variationCountInput.value, 10) || 5;
            
            setLoading(true, `0 / ${variationCount}`, 'Starting generation...');

            try {
                // 1. Preprocess the source image
                setLoading(true, `0 / ${variationCount}`, 'Processing source image...');
                if (!sourceFile.preprocessedB64) {
                    sourceFile.preprocessedB64 = await preprocessImage(sourceFile.file);
                }
                const sourceB64 = sourceFile.preprocessedB64;
                
                // 2. Call text model to get variation prompts (JSON)
                // We use the giant system prompt here
                setLoading(true, `0 / ${variationCount}`, 'Analyzing design & generating prompts...');
                const variationGenPrompt = VARIATION_GENERATION_SYSTEM_PROMPT(userPrompt);
                
                // We ask for N+2 prompts to get some variety, then slice
                const promptAnalysisRequest = `Based on the attached design, generate a JSON array of ${variationCount + 2} unique, commercially viable POD design variation prompts. ${variationGenPrompt}`;
                
                const variationPromptsJSON = await callGeminiText(promptAnalysisRequest, [sourceB64], true);

                let variationPrompts = [];
                try {
                    // The AI output might have markdown ```json ... ``` wrapper
                    const jsonString = variationPromptsJSON.replace(/```json\n|```/g, '').trim();
                    variationPrompts = JSON.parse(jsonString);
                    if (!Array.isArray(variationPrompts)) {
                        throw new Error('AI did not return a JSON array.');
                    }
                } catch (jsonError) {
                    console.error('Failed to parse JSON from AI:', variationPromptsJSON);
                    throw new Error('AI returned invalid prompt data. Please try again.');
                }
                
                variationPrompts = variationPrompts.slice(0, variationCount); // Get the number we asked for
                
                // 3. Loop and generate each image
                let completedJobs = 0;
                for (const prompt of variationPrompts) {
                    if (appState.currentJobId !== jobId) break; // Check for cancellation
                    
                    const statusText = `Generating variation ${completedJobs + 1} / ${variationCount}`;
                    setLoading(true, `${completedJobs + 1} / ${variationCount}`, statusText);
                    
                    // The prompt from the JSON array is the *full* prompt for the image model
                    const generatedImage = await callGeminiImage(prompt, [sourceB64]);
                    
                    // 4. Save and render
                    const design = {
                        id: generateId(),
                        image: generatedImage,
                        niche: `Variation of ${sourceFile.file.name.substring(0, 20)}...`,
                        prompt: prompt,
                        mode: 'variations',
                        favorite: false,
                        createdAt: Date.now()
                    };
                    
                    await dbUtils.saveDesign(design);
                    appState.generatedDesigns.unshift(design); // Add to start
                    renderResultCard(design, true); // Render with animation
                    
                    completedJobs++;
                }

                if (appState.currentJobId === jobId) {
                    showToast(`Successfully generated ${completedJobs} variations!`, 'success');
                }
                
            } catch (error) {
                console.error('Error during Variations generation:', error);
                showToast(`Generation failed: ${error.message}`, 'error');
            } finally {
                setLoading(false);
                appState.currentJobId = null;
            }
        };


        // ================================================================
        // RESULTS GALLERY & ACTIONS
        // ================================================================
        
        /**
         * Loads all designs from DB and renders them.
         */
        const loadAndRenderDesigns = async () => {
            try {
                const designs = await dbUtils.loadAllDesigns();
                appState.generatedDesigns = designs;
                DOMElements.resultsGrid.innerHTML = '';
                if (designs.length === 0) {
                    DOMElements.resultsGrid.innerHTML = '<p>No designs generated yet. Upload some images and get started!</p>';
                } else {
                    designs.forEach(design => renderResultCard(design, false));
                }
            } catch (error) {
                console.error('Failed to load designs:', error);
                showToast('Could not load saved designs.', 'error');
            }
        };

        /**
         * Renders a single design card in the results grid.
         * @param {object} design - The design object.
         * @param {boolean} [animate=false] - Whether to apply the fade-in animation.
         */
        const renderResultCard = (design, animate = false) => {
            const card = document.createElement('article');
            card.className = 'result-card';
            card.dataset.id = design.id;
            
            if (animate) {
                card.style.animationDelay = `${DOMElements.resultsGrid.children.length * 50}ms`;
            } else {
                card.style.opacity = 1;
                card.style.transform = 'none';
            }
            
            const isFavorited = design.favorite;

            card.innerHTML = `
                <div class="result-card-image">
                    <img src="${design.image}" alt="${design.niche}" loading="lazy">
                    <div class="action-buttons-overlay">
                        <button class="btn" data-action="view" title="View (Space)">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" /><path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 0 1 0-1.18c.861-.632 2.13-1.48 3.868-2.18C6.326 6.482 8.12 6 10 6c1.88 0 3.674.482 5.468 1.23.51.214 1.01.458 1.494.724.982.522 1.83.992 2.548 1.46a.75.75 0 0 1 0 1.18c-.719.468-1.566.938-2.548 1.46a48.7 48.7 0 0 1-1.494.724C13.674 13.518 11.88 14 10 14c-1.88 0-3.674-.482-5.468-1.23a48.8 48.8 0 0 1-1.494-.724C2.074 11.598 1.226 11.128.664 10.59Z" clip-rule="evenodd" /></svg>
                            View
                        </button>
                        <button class="btn" data-action="edit" title="Edit (E)">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="m13.586 3.586.47.47.043.043L16 6l-1 1-2.5-2.5 1-1 1.854 1.854.146.146.043.043Zm-2.35 2.35L13.5 8l-6.146 6.146a.75.75 0 0 1-.32.176l-3 1a.75.75 0 0 1-.885-.885l1-3a.75.75 0 0 1 .176-.32L11.236 5.936Z" /></svg>
                            Edit
                        </button>
                        <button class="btn" data-action="download" title="Download (D)">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" /><path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5a1.25 1.25 0 0 1-1.25 1.25H4.75A1.25 1.25 0 0 1 3.5 15.25v-2.5Z" /></svg>
                            Download
                        </button>
                    </div>
                </div>
                <div class="result-card-footer">
                    <p class="result-card-niche" title="${design.niche}">${design.niche}</p>
                    <div class="result-card-info">
                        <span class="result-card-time">${timeAgo(design.createdAt)}</span>
                        <button class="result-card-fav ${isFavorited ? 'favorited' : ''}" data-action="favorite" title="Favorite (F)">
                            ${isFavorited 
                                ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 0 0 .95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 0 0-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 0 0-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 0 0-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 0 0 .951-.69l1.07-3.292Z" /></svg>' 
                                : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.362c.513 0 .725.663.328.978l-4.326 3.118a.563.563 0 0 0-.192.686l1.638 5.03c.126.388-.33.72-.65.466l-4.504-3.27a.563.563 0 0 0-.626 0L5.337 22.11c-.32.253-.777-.078-.65-.466l1.638-5.03a.563.563 0 0 0-.192-.686L1.808 9.898c-.397-.315-.185-.978.328-.978h5.362a.563.563 0 0 0 .475-.31l2.125-5.11Z" /></svg>'
                            }
                        </button>
                    </div>
                </div>
            `;
            
            // Prepend to grid
            if (DOMElements.resultsGrid.firstChild && DOMElements.resultsGrid.firstChild.tagName === 'P') {
                DOMElements.resultsGrid.innerHTML = ''; // Clear "No designs" message
            }
            DOMElements.resultsGrid.prepend(card);
        };
        
        /**
         * Initializes listeners for actions on result cards.
         */
        const initResultCardActions = () => {
            DOMElements.resultsGrid.addEventListener('click', async (e) => {
                const button = e.target.closest('button[data-action], .result-card-image');
                if (!button) return;
                
                const card = e.target.closest('.result-card');
                const id = card.dataset.id;
                const design = appState.generatedDesigns.find(d => d.id === id);
                if (!design) return;

                let action = button.dataset.action;
                // Click on image defaults to 'view'
                if (button.classList.contains('result-card-image')) {
                    action = 'view';
                }

                switch (action) {
                    case 'view':
                        openImageViewer(design);
                        break;
                    case 'edit':
                        openEditModal(design);
                        break;
                    case 'download':
                        downloadBase64Image(design.image, `design-${design.id}.png`);
                        showToast('Downloading design...', 'success');
                        break;
                    case 'favorite':
                        await toggleFavorite(design, button);
                        break;
                    case 'delete':
                        // This is now handled in the overlay, but left for robustness
                        openDeleteModal(id);
                        break;
                }
            });
            
            // Add listener for delete button in the action overlay
            DOMElements.resultsGrid.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-action="delete"]');
                if (btn) {
                    const id = e.target.closest('.result-card').dataset.id;
                    openDeleteModal(id);
                }
            });
        };
        
        /**
         * Toggles the favorite status of a design.
         * @param {object} design - The design object.
         * @param {HTMLElement} button - The favorite button element.
         */
        const toggleFavorite = async (design, button) => {
            design.favorite = !design.favorite;
            await dbUtils.saveDesign(design); // Update in DB
            
            // Update UI
            button.classList.toggle('favorited', design.favorite);
            button.innerHTML = design.favorite 
                ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 0 0 .95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 0 0-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 0 0-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 0 0-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 0 0 .951-.69l1.07-3.292Z" /></svg>' 
                : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.362c.513 0 .725.663.328.978l-4.326 3.118a.563.563 0 0 0-.192.686l1.638 5.03c.126.388-.33.72-.65.466l-4.504-3.27a.563.563 0 0 0-.626 0L5.337 22.11c-.32.253-.777-.078-.65-.466l1.638-5.03a.563.563 0 0 0-.192-.686L1.808 9.898c-.397-.315-.185-.978.328-.978h5.362a.563.563 0 0 0 .475-.31l2.125-5.11Z" /></svg>';
            
            showToast(design.favorite ? 'Added to favorites!' : 'Removed from favorites.', 'success');
        };

        /**
         * Opens the confirm delete modal.
         * @param {string} id - The ID of the design to delete.
         */
        const openDeleteModal = (id) => {
            DOMElements.confirmDeleteBtn.dataset.id = id; // Store ID on the button
            openModal(DOMElements.confirmDeleteModal);
        };
        
        /**
         * Handles the final deletion of a design.
         */
        const handleDeleteDesign = async () => {
            const id = DOMElements.confirmDeleteBtn.dataset.id;
            if (!id) return;

            try {
                await dbUtils.deleteDesign(id);
                // Remove from state
                const index = appState.generatedDesigns.findIndex(d => d.id === id);
                if (index > -1) {
                    appState.generatedDesigns.splice(index, 1);
                }
                // Remove from UI
                const card = DOMElements.resultsGrid.querySelector(`.result-card[data-id="${id}"]`);
                if (card) {
                    card.style.animation = 'fadeOut 0.3s ease-out forwards';
                    card.addEventListener('animationend', () => card.remove());
                }
                
                showToast('Design deleted.', 'success');
            } catch (error) {
                console.error('Failed to delete design:', error);
                showToast('Could not delete design.', 'error');
            } finally {
                closeModal();
            }
        };

        // ================================================================
        // IMAGE VIEWER MODAL LOGIC
        // ================================================================
        
        const openImageViewer = (design) => {
            const index = appState.generatedDesigns.findIndex(d => d.id === design.id);
            appState.viewerState.currentIndex = index;
            appState.viewerState.currentId = design.id;
            
            updateImageViewerContent();
            resetViewerZoom();
            openModal(DOMElements.imageViewerModal);
        };
        
        const updateImageViewerContent = () => {
            const index = appState.viewerState.currentIndex;
            const design = appState.generatedDesigns[index];
            if (!design) return;
            
            appState.viewerState.currentId = design.id;
            DOMElements.viewerImg.src = design.image;
            
            // Update nav buttons
            DOMElements.viewerPrevBtn.disabled = index === 0;
            DOMElements.viewerNextBtn.disabled = index === appState.generatedDesigns.length - 1;
        };
        
        const resetViewerZoom = () => {
            appState.viewerState.zoom = 1;
            appState.viewerState.offsetX = 0;
            appState.viewerState.offsetY = 0;
            applyViewerTransform();
            DOMElements.viewerImg.classList.remove('zoomed');
        };

        const applyViewerTransform = () => {
            const { zoom, offsetX, offsetY } = appState.viewerState;
            DOMElements.viewerImg.style.transform = `scale(${zoom}) translate(${offsetX}px, ${offsetY}px)`;
        };
        
        const initViewerControls = () => {
            // Nav
            DOMElements.viewerPrevBtn.addEventListener('click', () => {
                if (appState.viewerState.currentIndex > 0) {
                    appState.viewerState.currentIndex--;
                    updateImageViewerContent();
                }
            });
            
            DOMElements.viewerNextBtn.addEventListener('click', () => {
                if (appState.viewerState.currentIndex < appState.generatedDesigns.length - 1) {
                    appState.viewerState.currentIndex++;
                    updateImageViewerContent();
                }
            });

            // Zoom
            DOMElements.viewerZoomInBtn.addEventListener('click', () => {
                appState.viewerState.zoom = Math.min(appState.viewerState.zoom + 0.25, 5);
                applyViewerTransform();
                DOMElements.viewerImg.classList.add('zoomed');
            });
            DOMElements.viewerZoomOutBtn.addEventListener('click', () => {
                appState.viewerState.zoom = Math.max(appState.viewerState.zoom - 0.25, 0.5);
                if(appState.viewerState.zoom === 1) resetViewerZoom();
                else applyViewerTransform();
                DOMElements.viewerImg.classList.toggle('zoomed', appState.viewerState.zoom > 1);
            });
            DOMElements.viewerZoomResetBtn.addEventListener('click', resetViewerZoom);
            
            // Pan/Drag
            DOMElements.viewerImg.addEventListener('mousedown', (e) => {
                if (appState.viewerState.zoom <= 1) return;
                e.preventDefault();
                appState.viewerState.isDragging = true;
                appState.viewerState.lastX = e.clientX;
                appState.viewerState.lastY = e.clientY;
                DOMElements.viewerImg.style.cursor = 'grabbing';
            });
            
            DOMElements.viewerContainer.addEventListener('mousemove', (e) => {
                if (!appState.viewerState.isDragging) return;
                const deltaX = e.clientX - appState.viewerState.lastX;
                const deltaY = e.clientY - appState.viewerState.lastY;
                
                // Convert pixel movement to translated movement
                appState.viewerState.offsetX += deltaX / appState.viewerState.zoom;
                appState.viewerState.offsetY += deltaY / appState.viewerState.zoom;
                
                appState.viewerState.lastX = e.clientX;
                appState.viewerState.lastY = e.clientY;
                
                applyViewerTransform();
            });

            const stopDragging = () => {
                if (appState.viewerState.isDragging) {
                    appState.viewerState.isDragging = false;
                    DOMElements.viewerImg.style.cursor = appState.viewerState.zoom > 1 ? 'grab' : 'default';
                }
            };
            DOMElements.viewerContainer.addEventListener('mouseup', stopDragging);
            DOMElements.viewerContainer.addEventListener('mouseleave', stopDragging);

            // Wheel zoom
            DOMElements.viewerContainer.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newZoom = Math.max(0.5, Math.min(appState.viewerState.zoom + delta, 5));
                
                // TODO: Add zoom to cursor position logic
                
                appState.viewerState.zoom = newZoom;
                
                if (appState.viewerState.zoom === 1) resetViewerZoom();
                else {
                    applyViewerTransform();
                    DOMElements.viewerImg.classList.add('zoomed');
                }
            });

            // Actions
            DOMElements.viewerDownloadBtn.addEventListener('click', () => {
                const design = appState.generatedDesigns[appState.viewerState.currentIndex];
                if(design) downloadBase64Image(design.image, `design-${design.id}.png`);
            });
            
            DOMElements.viewerEditBtn.addEventListener('click', () => {
                const design = appState.generatedDesigns[appState.viewerState.currentIndex];
                if(design) {
                    closeModal(); // Close viewer
                    openEditModal(design); // Open edit modal
                }
            });

            // Keyboard shortcuts (only when modal is active)
            window.addEventListener('keydown', (e) => {
                if (appState.activeModal !== DOMElements.imageViewerModal) return;

                const design = appState.generatedDesigns[appState.viewerState.currentIndex];
                if (!design) return;

                switch (e.key) {
                    case 'ArrowLeft':
                        DOMElements.viewerPrevBtn.click();
                        break;
                    case 'ArrowRight':
                        DOMElements.viewerNextBtn.click();
                        break;
                    case 'd':
                    case 'D':
                        e.preventDefault();
                        DOMElements.viewerDownloadBtn.click();
                        break;
                    case 'e':
                    case 'E':
                        e.preventDefault();
                        DOMElements.viewerEditBtn.click();
                        break;
                    case '+':
                    case '=':
                        e.preventDefault();
                        DOMElements.viewerZoomInBtn.click();
                        break;
                    case '-':
                    case '_':
                        e.preventDefault();
DOMElements.viewerZoomOutBtn.click();
                        break;
                    case '0':
                        e.preventDefault();
                        DOMElements.viewerZoomResetBtn.click();
                        break;
                }
            });
        };

        // ================================================================
        // EDIT MODAL & REGENERATION
        // ================================================================

        /**
         * Opens the edit modal with the selected design.
         * @param {object} design - The design object.
         */
        const openEditModal = (design) => {
            appState.editState.designId = design.id;
            appState.editState.originalImage = design.image;
            
            DOMElements.editOriginalImg.src = design.image;
            DOMElements.editNewImg.src = "https://placehold.co/500x500/f0f0f0/ccc?text=New+Design"; // Placeholder
            DOMElements.editPromptInput.value = '';
            
            openModal(DOMElements.editDesignModal);
        };
        
        /**
         * Handles the "Regenerate" button click in the edit modal.
         */
        const handleRegenerateEdit = async () => {
            const { designId, originalImage } = appState.editState;
            const promptText = DOMElements.editPromptInput.value.trim();
            
            if (!designId || !originalImage) return;
            if (!promptText) {
                showToast('Please enter an edit prompt.', 'warning');
                return;
            }
            
            const originalDesign = appState.generatedDesigns.find(d => d.id === designId);
            if (!originalDesign) {
                showToast('Original design not found.', 'error');
                return;
            }
            
            setLoading(true, '1/1', 'Regenerating design...');
            closeModal(); // Close edit modal

            try {
                // Use the edit system prompt
                const fullPrompt = EDIT_DESIGN_SYSTEM_PROMPT(promptText);
                
                // Call image model with the original image
                const generatedImage = await callGeminiImage(fullPrompt, [originalImage]);
                
                // Create new design object (or update)
                // We will update the existing one
                originalDesign.image = generatedImage;
                originalDesign.prompt = fullPrompt; // Update prompt to reflect edit
                originalDesign.createdAt = Date.now(); // Update timestamp
                
                // Save to DB
                await dbUtils.saveDesign(originalDesign);
                
                // Update in UI
                const card = DOMElements.resultsGrid.querySelector(`.result-card[data-id="${designId}"]`);
                if (card) {
                    card.querySelector('.result-card-image img').src = generatedImage;
                    card.querySelector('.result-card-time').textContent = 'Just now';
                }
                
                showToast('Design updated successfully!', 'success');
                
            } catch (error) {
                console.error('Error regenerating design:', error);
                showToast(`Regeneration failed: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        };

        // ================================================================
        // "MAGIC ENHANCE" AI PROMPT
        // ================================================================
        
        /**
         * Handles the "Magic Enhance" button click.
         */
        const handleMagicEnhance = async (e) => {
            const isNormal = e.target.id === 'normal-magic-enhance';
            const textarea = isNormal ? DOMElements.normalPrompt : DOMElements.variationPrompt;
            const currentPrompt = textarea.value.trim();
            
            if (!currentPrompt) {
                showToast('Please write a prompt first to enhance it.', 'warning');
                return;
            }
            
            setLoading(true, '', 'Enhancing prompt...');
            
            try {
                const enhanceSystemPrompt = `You are a prompt engineering expert for AI image generation, specializing in POD designs. 
                Rewrite and enhance this user's simple prompt into a more descriptive and effective prompt for an AI image generator. 
                Keep the core idea but add details about style, composition, and keywords. 
                Respond with ONLY the enhanced prompt text, no pleasantries.`;
                
                const enhancedPrompt = await callGeminiText(enhanceSystemPrompt + `\n\nUser prompt: "${currentPrompt}"`);
                
                textarea.value = enhancedPrompt.replace(/['"]+/g, ''); // Clean quotes
                updateCharCounter(textarea, isNormal ? DOMElements.normalCharCounter : DOMElements.variationCharCounter);
                showToast('Prompt enhanced!', 'success');
                
            } catch (error) {
                console.error('Error enhancing prompt:', error);
                showToast(`Failed to enhance prompt: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        };


        // ================================================================
        // APPLICATION INITIALIZATION
        // ================================================================

        /**
         * Main application initialization function.
         */
        const initApp = async () => {
            // 1. Setup Theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (savedTheme === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                toggleTheme(true);
            } else {
                toggleTheme(false);
            }
            DOMElements.themeToggleBtn.addEventListener('click', () => toggleTheme());

            // 2. Setup Modals
            initModalListeners();
            DOMElements.apiKeySaveBtn.addEventListener('click', handleSaveAPIKey);
            DOMElements.apiKeyClearBtn.addEventListener('click', handleClearAPIKey);
            DOMElements.apiKeyTestBtn.addEventListener('click', handleTestAPIKey);
            DOMElements.confirmDeleteBtn.addEventListener('click', handleDeleteDesign);
            DOMElements.regenerateBtn.addEventListener('click', handleRegenerateEdit);

            // 3. Setup Mode Toggle
            DOMElements.modeToggleButtons.forEach(btn => {
                btn.addEventListener('click', () => switchMode(btn.dataset.mode));
            });

            // 4. Setup Drag & Drop
            initDragAndDrop();
            
            // 5. Setup Thumbnail Grid Actions
            initThumbnailGridActions();
            
            // 6. Setup Textarea Counters
            DOMElements.normalPrompt.addEventListener('input', () => updateCharCounter(DOMElements.normalPrompt, DOMElements.normalCharCounter));
            DOMElements.variationPrompt.addEventListener('input', () => updateCharCounter(DOMElements.variationPrompt, DOMElements.variationCharCounter));
            DOMElements.variationCountInput.addEventListener('input', updateGenerationButtons);

            // 7. Setup Generation Buttons
            DOMElements.normalGenBtn.addEventListener('click', handleGenerateNormal);
            DOMElements.variationGenBtn.addEventListener('click', handleGenerateVariations);
            DOMElements.cancelGenerationBtn.addEventListener('click', cancelGeneration);
            
            // 8. Setup Magic Enhance
            $('#normal-magic-enhance').addEventListener('click', handleMagicEnhance);
            $('#variation-magic-enhance').addEventListener('click', handleMagicEnhance);

            // 9. Setup Results Gallery
            initResultCardActions();
            initViewerControls();
            
            // 10. Scroll to "My AI Designs"
            DOMElements.myDesignsLink.addEventListener('click', (e) => {
                e.preventDefault();
                DOMElements.resultsGallery.scrollIntoView({ behavior: 'smooth' });
            });

            // 11. Initialize Database
            try {
                await dbUtils.initDB();
                // 12. Load API Key
                await loadAndDecryptApiKey();
                // 13. Load Designs
                await loadAndRenderDesigns();
            } catch (error) {
                console.error('Failed to initialize database:', error);
                showToast('Failed to load database. App may not work correctly.', 'error');
            }

            // 14. Final UI update
            updateGenerationButtons();
            
            console.log('AI Design Generator initialized.');
        };

        // Start the application once the DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
